---
title: "$r^2f$ Simulation Results Summary"
author: ""
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: vthemes::vmodern
params:
  results_dir: 
    label: "Results directory"
    value: "/global/scratch/users/tiffanytang/feature_importance/results/"
  seed:
    label: "Seed"
    value: 12345
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(magrittr)
library(patchwork)
chunk_idx <- 1

# set parameters
results_dir <- params$results_dir
seed <- params$seed
plots_dir <- file.path("plots")
if (!dir.exists(file.path(plots_dir, "appendix"))) {
  dir.create(file.path(plots_dir, "appendix"), recursive = TRUE)
}

# miscellaneous helper variables
p_models <- list(
  ccle_prot = 214,
  ukbb = 500,
  german = 20,
  fmri = 500
)
heritabilities <- c(0.1, 0.2, 0.4, 0.8)
metrics_all <- c("rocauc", "prauc")

# plot options
point_size <- 2
line_size <- 1
errbar_width <- 0
manual_color_palette <- c("black", "orange", "#71beb7", "#218a1e", "#cc3399")
show_methods <- c("r2f", "Permutation_RF", "MDI_RF", "MDI-oob_RF", "TreeSHAP_RF")
method_labels <- c(bquote(~r^2*"f"), "Permutation", "MDI", "MDI-oob", "TreeSHAP")
custom_theme <- vthemes::theme_vmodern(
  size_preset = "medium", bg_color = "white", grid_color = "white",
  axis.ticks = ggplot2::element_line(size = ggplot2::rel(2), colour = "black"),
  axis.text = ggplot2::element_text(size = 14),
  axis.title = ggplot2::element_text(size = 20, face = "plain"),
  legend.text = ggplot2::element_text(size = 14),
  plot.title = ggplot2::element_blank()
  # plot.title = ggplot2::element_text(size = 12, face = "plain", hjust = 0.5)
)

source("../../scripts/viz.R", chdir = TRUE)
```

# PCA Investigations: Figure 2, 7

# Main Simulations: Figure 3

```{r}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")
metric <- "rocauc"

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(
        metric == "rocauc" ~ "AUROC",
        metric == "prauc" ~ "PRAUC"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, sprintf("real_data_artificial_y_sims_%s_%s_%s_errbars.pdf", 
                                   y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# Augmented fMRI Simulation: Figure 4

```{r}
fname <- file.path(results_dir, "r2f.fmri_augmented_dgp", 
                   "varying_sample_col_n_sample_row_n",
                   paste0("seed", seed), "results.csv")
results <- data.table::fread(fname) %>%
  reformat_results()
ps <- unique(results$sample_col_n)

plt_ls <- list()
for (p in ps) {
  plt <- results %>%
    dplyr::filter(sample_col_n == !!p) %>%
    plot_metrics(
      metric = "rocauc",
      x_str = "sample_row_n", 
      facet_str = NULL, 
      point_size = point_size, 
      line_size = line_size, 
      errbar_width = errbar_width, 
      manual_color_palette = manual_color_palette, 
      show_methods = show_methods, 
      method_labels = method_labels, 
      custom_theme = custom_theme, 
      inside_legend = FALSE
    ) +
    ggplot2::coord_cartesian(ylim = c(0.77, 1)) +
    ggplot2::labs(
      x = "Sample Size", y = "AUROC",
      color = "Method", alpha = "Method"
    )
  if (p != ps[1]) {
    plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
  }
  plt_ls[[as.character(p)]] <- plt
}

plt <- purrr::reduce(plt_ls, `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14),
    legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 1, guides = "collect")
ggplot2::ggsave(
  file.path(plots_dir, "fmri_augmented_sims.pdf"),
  plot = plt, units = "in", width = 12, height = 3
)

```

# Stability Simulations: Figure 5, 23-25

# MDI Bias: Figure 6

```{r eval=FALSE}
fname <- file.path("results_entropy.csv")
results <- data.table::fread(fname) %>%
  reformat_results()

plt_ls <- list()
for (metric in metrics_all) {
  metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                  metric == "prauc" ~ "AUPRC")
  plt <- results %>%
    plot_metrics(
      metric = metric,
      x_str = "n", 
      facet_str = NULL, 
      point_size = point_size, 
      line_size = line_size, 
      errbar_width = errbar_width, 
      manual_color_palette = manual_color_palette, 
      show_methods = show_methods, 
      method_labels = method_labels, 
      custom_theme = custom_theme, 
      inside_legend = FALSE
    ) +
    ggplot2::labs(
      x = "Sample Size", y = metric_name,
      color = "Method", alpha = "Method"
    )
  plt_ls[[metric]] <- plt
}

plt <- purrr::reduce(plt_ls, `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14),
    legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 1, guides = "collect")
ggplot2::ggsave(
  file.path(plots_dir, "appendix", "entropy_sims.pdf"),
  plot = plt, units = "in", width = 8.5, height = 3
)


```

# $r^2f$ Modeling Choices: Figure 8

```{r}
vary_param_name <- "heritability_sample_row_n"
cur_manual_color_palette <- c("black", "#ff9902", "#6caa52", "#4a86e8", "#a64d79")
cur_show_methods <- c("r2f", 
                      "r2f (Without Refit)", 
                      "r2f (Without Xk)", 
                      "r2f (AIC)", 
                      "r2f (CV)")
cur_method_labels <- c(bquote(~r^2*"f"), 
                       bquote(~r^2*"f (No Refit)"), 
                       bquote(~r^2*"f (No"~X[k]*")"), 
                       bquote(~r^2*"f (AIC)"), 
                       bquote(~r^2*"f (CV)"))
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")
metric <- "rocauc"

results_ls <- list()
for (y_model in y_models) {
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.r2f_algorithmic_choices.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

for (x_model in x_models) {
  plt_ls <- list()
  for (y_model in y_models) {
    plt_ls[[y_model]] <- list()
    for (h in heritabilities) {
      metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                      metric == "prauc" ~ "AUPRC")
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = cur_manual_color_palette, 
          show_methods = cur_show_methods, 
          method_labels = cur_method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        ) +
        ggplot2::theme(
          legend.position = c(0.75, 0.4),
          legend.background = ggplot2::element_rect(
            color = "slategray", size = .1
          )
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (y_model != y_models[length(y_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) |
          (y_model != y_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[y_model]][[as.character(h)]] <- plt
    }
    
    plt <- purrr::reduce(plt_ls[[y_model]], `+`) *
      ggplot2::theme(
        axis.text = ggplot2::element_text(size = 11),
        axis.title = ggplot2::element_text(size = 16, face = "plain"),
        legend.text = ggplot2::element_text(size = 14)
        # legend.title = ggplot2::element_text(face = "plain", size = 16)
      ) +
      plot_layout(nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix", 
                sprintf("model_choices_%s_%s_%s.pdf", y_model, x_model, metric)),
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```


# AUROC Appendix: Figures 9-12

```{r}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int", "linear_lss")
x_models <- c("german", "ukbb", "ccle_prot", "fmri")
metric <- "rocauc"

results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(
        metric == "rocauc" ~ "AUROC",
        metric == "prauc" ~ "PRAUC"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sims_appendix_%s_%s_%s_errbars.pdf", 
                        y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# AUPRC Appendix: Figures 13-16

```{r}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int", "linear_lss")
x_models <- c("german", "ukbb", "ccle_prot", "fmri")
metric <- "prauc"

results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(
        metric == "rocauc" ~ "AUROC",
        metric == "prauc" ~ "PRAUC"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sims_appendix_%s_%s_%s_errbars.pdf", 
                        y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# TPR Appendix: Figure 17

```{r}
y_models <- "linear"
x_models <- c("german", "ukbb")

results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

facet_vars <- c("PVE" = "heritability", "n" = "sample_row_n")
for (x_model in x_models) {
  for (y_model in y_models) {
    results <- results_ls[[y_model]][[x_model]]
    plt <- results %>%
      plot_tpr(facet_vars = facet_vars, 
               manual_color_palette = manual_color_palette, 
               show_methods = show_methods,
               method_labels = method_labels, 
               custom_theme = vthemes::theme_vmodern(size_preset = "medium")) +
      ggplot2::coord_cartesian(xlim = c(1, 10)) +
      ggplot2::scale_x_continuous(breaks = c(2, 4, 6, 8, 10)) +
      ggplot2::theme(panel.background = ggplot2::element_rect(fill = "white"), 
                     panel.grid.major = ggplot2::element_line(size = .1))
    ncols <- length(unique(results$sample_row_n))
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sims_appendix_%s_%s_tpr.pdf", 
                        y_model, x_model)), 
      plot = plt, units = "in", width = 12, height = 1.5 * ncols
    )
  }
}
```

# Misspecified Model Appendix: Figures 18-19

```{r}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name, "_omitted_vars"), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

for (metric in metrics_all) {
  plt_ls <- list()
  for (h in heritabilities) {
    plt_ls[[as.character(h)]] <- list()
    for (x_model in x_models) {
      plt_ls[[as.character(h)]][[x_model]] <- list()
      for (y_model in y_models) {
        sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
        sim_title <- dplyr::case_when(
          x_model == "ccle_prot" ~ "CCLE Protein",
          x_model == "ukbb" ~ "UK Biobank",
          x_model == "german" ~ "German Credit",
          x_model == "fmri" ~ "fMRI"
        )
        metric_name <- dplyr::case_when(
          metric == "rocauc" ~ "AUROC",
          metric == "prauc" ~ "PRAUC"
        )
        plt <- results_ls[[y_model]][[x_model]] %>%
          dplyr::filter(heritability == !!h) %>%
          plot_metrics(
            metric = metric,
            x_str = "sample_row_n", 
            facet_str = NULL, 
            point_size = point_size, 
            line_size = line_size, 
            errbar_width = errbar_width, 
            manual_color_palette = manual_color_palette, 
            show_methods = show_methods, 
            method_labels = method_labels, 
            custom_theme = custom_theme, 
            inside_legend = TRUE
          ) +
          ggplot2::labs(
            x = "Sample Size", y = metric_name,
            color = "Method", alpha = "Method",
            title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
          )
        if (h != heritabilities[1]) {
          plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
        }
        if (x_model != x_models[length(x_models)]) {
          plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
        }
        if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
          plt <- plt + ggplot2::guides(color = "none", alpha = "none")
        }
        plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
      }
    }
  }
  
  for (y_model in y_models) {
    for (x_model in x_models) {
      plt <- list()
      for (h in heritabilities) {
        cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
        if (identical(plt, list())) {
          plt <- cur_plt
        } else {
          plt <- plt + cur_plt
        }
      }
      plt <- plt +
        plot_layout(ncol = length(heritabilities), nrow = 1)
      ggplot2::ggsave(
        file.path(plots_dir, "appendix",
                  sprintf("real_data_artificial_y_omitted_vars_sims_%s_%s_%s_errbars.pdf", 
                          y_model, x_model, metric)), 
        plot = plt, units = "in", width = 14, height = 3
      )
    }
  }
}

```

# Varying Sparsity Appendix: Figure 20

```{r}
vary_param_names <- c("linear" = "heritability_s", 
                      "lss" = "heritability_m",
                      "poly_int" = "heritability_m")
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")
metric <- "rocauc"

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.sparsity_sims.", sim_name), 
                       paste0("varying_", vary_param_names[y_model]), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                      metric == "prauc" ~ "AUPRC")
      x_str <- ifelse(y_model == "linear", "s", "m")
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = x_str, 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = toupper(x_str), y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sparsity_sims_%s_%s_%s_errbars.pdf", 
                        y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# Logistic Regression Appendix: Figure 21

```{r}
vary_param_name <- "sample_row_n"
y_models <- "logistic"
x_models <- c("german", "ukbb", "ccle_prot", "fmri")

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name),
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (metric in metrics_all) {
  metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                  metric == "prauc" ~ "AUPRC")
  for (x_model in x_models) {
    plt_ls[[metric]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (x_model != x_models[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (metric == metrics_all[1]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((x_model != x_models[length(x_models)]) | (metric != metrics_all[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[metric]][[x_model]] <- plt
    }
  }
}

plt <- purrr::reduce(c(plt_ls$rocauc, plt_ls$prauc), `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14)
    # legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 2)
ggplot2::ggsave(
  file.path(plots_dir, "appendix", "logistic_dgp.pdf"),
  plot = plt, units = "in", width = 14, height = 6
)

```

# CART Simulation Appendix: Figure 22

```{r}
fname <- file.path(results_dir, "r2f.ccle_prot_cart_dgp", 
                   "varying_heritability_n",
                   paste0("seed", seed), "results.csv")
results <- data.table::fread(fname) %>%
  reformat_results()

plt_ls <- list()
for (metric in metrics_all) {
  metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                  metric == "prauc" ~ "AUPRC")
  plt_ls[[metric]] <- list()
  for (h in heritabilities) {
    plt <- results %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
    if (h != heritabilities[1]) {
      plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
    }
    plt_ls[[metric]][[as.character(h)]] <- plt
  }
}

plt <- purrr::reduce(c(plt_ls$rocauc, plt_ls$prauc), `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14),
    legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 2, guides = "collect")
ggplot2::ggsave(
  file.path(plots_dir, "appendix", "ccle_prot_cart_dgp.pdf"),
  plot = plt, units = "in", width = 14, height = 6
)

```


