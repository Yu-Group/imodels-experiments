---
title: "$r^2f$ Simulation Results Summary"
author: ""
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: vthemes::vmodern
params:
  results_dir: 
    label: "Results directory"
    value: "/global/scratch/users/tiffanytang/feature_importance/results/"
  seed:
    label: "Seed"
    value: 12345
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(magrittr)
library(patchwork)
chunk_idx <- 1

# set parameters
results_dir <- params$results_dir
seed <- params$seed
plots_dir <- file.path("plots")
if (!dir.exists(file.path(plots_dir, "appendix"))) {
  dir.create(file.path(plots_dir, "appendix"), recursive = TRUE)
}

# miscellaneous helper variables
p_models <- list(
  ccle_prot = 214,
  ukbb = 500,
  german = 20,
  fmri = 500
)
heritabilities <- c(0.1, 0.2, 0.4, 0.8)
metrics_all <- c("rocauc", "prauc")

# plot options
point_size <- 2
line_size <- 1
errbar_width <- 0
manual_color_palette <- c("black", "orange", "#71beb7", "#218a1e", "#cc3399")
show_methods <- c("r2f", "Permutation_RF", "MDI_RF", "MDI-oob_RF", "TreeSHAP_RF")
method_labels <- c(bquote(~r^2*"f"), "Permutation", "MDI", "MDI-oob", "TreeSHAP")
custom_theme <- vthemes::theme_vmodern(
  size_preset = "medium", bg_color = "white", grid_color = "white",
  axis.ticks = ggplot2::element_line(size = ggplot2::rel(2), colour = "black"),
  axis.text = ggplot2::element_text(size = 14),
  axis.title = ggplot2::element_text(size = 20, face = "plain"),
  legend.text = ggplot2::element_text(size = 14),
  plot.title = ggplot2::element_blank()
  # plot.title = ggplot2::element_text(size = 12, face = "plain", hjust = 0.5)
)
custom_theme_with_legend <- vthemes::theme_vmodern(
  size_preset = "medium", bg_color = "white", grid_color = "white",
  axis.title = ggplot2::element_text(size = 12, face = "plain"),
  legend.text = ggplot2::element_text(size = 9),
  legend.text.align = 0,
  plot.title = ggplot2::element_blank()
)
custom_theme_without_legend <- vthemes::theme_vmodern(
  size_preset = "medium", bg_color = "white", grid_color = "white",
  axis.title = ggplot2::element_text(size = 12, face = "plain"),
  legend.title = ggplot2::element_blank(),
  legend.text = ggplot2::element_text(size = 9),
  legend.text.align = 0,
  plot.title = ggplot2::element_blank()
)

source("../../scripts/viz.R", chdir = TRUE)
```

# PCA Investigations: Figure 2, 7

```{r}
pca_dir <- ""
green <- "#417064"
red <- "#c76349"

facet_header_true <- ggplot2::theme(
  strip.background = ggplot2::element_rect(fill = "#2c3e50", color = "white", size = 1)
)
facet_header_selected <- ggplot2::theme(
  strip.background = ggplot2::element_rect(fill = "#007ea7", color = "white", size = 1)
)
facet_header_nonselected <- ggplot2::theme(
  strip.background = ggplot2::element_rect(fill = "slategray", color = "white", size = 1)
)
fill_scheme <- ggplot2::scale_fill_gradient2(low = red, mid = "white", high = green, midpoint = 0)
point_color <- "#023047"

#### xor ####
X_xor <- data.table::fread(file.path(pca_dir, "X.csv"), drop = 1) %>%
  as.data.frame()
pca_results <- data.table::fread(file.path(pca_dir, "pca_results.csv"), drop = 1) %>%
  as.data.frame()
color_code <- data.table::fread(file.path(pca_dir, "color_code.csv"), drop = 1) %>%
  as.data.frame()

selected_pcs <- which(pca_results$lasso_coef != 0)
nonselected_pc <- which(pca_results$lasso_coef == 0)[1]

# true xor regression surface
xor_plt <- list(x1 = seq(-2.1, 2, by = 0.2), 
                x2 = seq(-2.1, 2, by = 0.2)) %>%
  expand.grid() %>%
  dplyr::mutate(
    y = ifelse(x1 > 0, x2 > 0, x2 < 0) * 1,
    group = "Regression Func."
  ) %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = x1, y = x2, fill = y, color = y) +
  ggplot2::geom_tile(alpha = 1, size = 0) +
  ggplot2::facet_grid(~ group) +
  ggplot2::scale_fill_gradient2(low = red, mid = "white", high = green, midpoint = 0.5) +
  ggplot2::scale_color_gradient2(low = red, mid = "white", high = green, midpoint = 0.5) +
  ggplot2::coord_cartesian(expand = FALSE) +
  ggplot2::labs(x = expression(X[1]), y = expression(X[2]),
                fill = "PC\nScore", color = "PC\nScore") +
  custom_theme_with_legend +
  facet_header_true

# round correlations
pca_results <- pca_results %>%
  dplyr::mutate(
    corr_with_target = ifelse(round(corr_with_target, 2) == 0,
                              round(corr_with_target, 3),
                              round(corr_with_target, 2))
  )

# get plotting data frame
pca_plt_df <- purrr::map_dfr(
  c(selected_pcs, nonselected_pc),
  ~data.frame(X1 = X_xor[, 1], X2 = X_xor[, 2], 
              color = color_code[, .x], pc = .x)
) %>%
  dplyr::mutate(
    group = sprintf("PC%s (%s)", pc, pca_results$corr_with_target[pc])
  ) %>%
  dplyr::mutate(
    X1 = round(X1, 1),
    X2 = round(X2, 1)
  ) %>%
  dplyr::distinct(X1, X2, group, .keep_all = TRUE) %>%
  dplyr::group_by(X1, X2, group) %>%
  dplyr::summarise(color = mean(color), .groups = "keep") %>%
  dplyr::ungroup()

# make selected pc plots
selected_plt1 <- pca_plt_df %>%
  dplyr::filter(stringr::str_detect(group, paste0("PC", selected_pcs[1]))) %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = X1, y = X2, fill = color) +
  ggplot2::geom_tile() +
  ggplot2::facet_grid(~ group) +
  ggplot2::coord_cartesian(expand = FALSE) +
  ggplot2::labs(x = expression(X[1]), y = expression(X[2]),
                fill = "PC\nScore", color = "PC\nScore") +
  custom_theme_without_legend +
  facet_header_selected +
  fill_scheme +
  ggplot2::guides(fill = "none")
selected_plt2 <- pca_plt_df %>%
  dplyr::filter(stringr::str_detect(group, paste0("PC", selected_pcs[2]))) %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = X1, y = X2, fill = color) +
  ggplot2::geom_tile() +
  ggplot2::facet_grid(~ group) +
  ggplot2::coord_cartesian(expand = FALSE) +
  ggplot2::labs(x = expression(X[1]), y = expression(X[2]),
                fill = "PC\nScore", color = "PC\nScore") +
  custom_theme_without_legend +
  facet_header_selected +
  fill_scheme +
  ggplot2::guides(fill = "none")

# make nonselected pc plot
nonselected_plt <- pca_plt_df %>%
  dplyr::filter(stringr::str_detect(group, paste0("PC", nonselected_pc))) %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = X1, y = X2, fill = color) +
  ggplot2::geom_tile() +
  ggplot2::facet_grid(~ group) +
  ggplot2::coord_cartesian(expand = FALSE) +
  ggplot2::labs(x = expression(X[1]), y = expression(X[2]),
                fill = "PC\nScore", color = "PC\nScore") +
  custom_theme_without_legend +
  facet_header_nonselected +
  fill_scheme +
  ggplot2::guides(fill = "none")

plt <- xor_plt + selected_plt1 + selected_plt2 + nonselected_plt + 
  plot_layout(nrow = 1, guides = "collect")

ggplot2::ggsave(filename = file.path(plots_dir, "xor_h04_n500.pdf"), 
                plot = plt, units = 'in', width = 10, height = 2.5)

#### sums of squares ####
X_ss <- data.table::fread(file.path(pca_dir, "ss_0.4_n500_X.csv"), drop = 1) %>%
  as.data.frame()
pca_results <- data.table::fread(file.path(pca_dir, "ss_0.4_n500_pca_results.csv"), drop = 1) %>%
  as.data.frame()
color_code <- data.table::fread(file.path(pca_dir, "ss_0.4_n500_color_code.csv"), drop = 1) %>%
  as.data.frame()

selected_pcs <- which(pca_results$lasso_coef != 0)
nonselected_pc <- which(pca_results$lasso_coef == 0)[1]

# true xor regression surface
ss_plt <- data.frame(x = seq(-4, 4, by = 0.1)) %>%
  dplyr::mutate(y = x^2, 
                group = "Regression Function") %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = x, y = y) +
  ggplot2::facet_grid(~ group) +
  ggplot2::geom_line(color = point_color, size = 1) +
  ggplot2::labs(x = expression(X[1]), y = expression({X[1]}^2)) +
  custom_theme_without_legend +
  facet_header_true +
  ggplot2::theme(
    axis.text.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank()
  )

# round correlations
pca_results <- pca_results %>%
  dplyr::mutate(
    corr_with_target = ifelse(round(corr_with_target, 2) == 0,
                              round(corr_with_target, 3),
                              round(corr_with_target, 2))
  )

# get plotting data frame
pca_plt_df <- purrr::map_dfr(
  c(selected_pcs, nonselected_pc),
  ~data.frame(X1 = X_ss[, 1], X2 = X_ss[, 2], 
              color = color_code[, .x], pc = .x)
) %>%
  dplyr::mutate(
    group = sprintf("PC%s (%s)", pc, pca_results$corr_with_target[pc])
  ) %>%
  dplyr::sample_frac(0.25)

# make selected pc plots
selected_plt1 <- pca_plt_df %>%
  dplyr::filter(stringr::str_detect(group, paste0("PC", selected_pcs[1]))) %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = X1, y = color) +
  ggplot2::geom_point(size = 0.01, alpha = 0.7, color = point_color) +
  ggplot2::facet_grid(~ group) +
  ggplot2::labs(x = expression(X[1]), y = paste0("PC", selected_pcs[1])) +
  custom_theme_without_legend +
  facet_header_selected
selected_plt2 <- pca_plt_df %>%
  dplyr::filter(stringr::str_detect(group, paste0("PC", selected_pcs[2]))) %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = X1, y = color) +
  ggplot2::geom_point(size = 0.01, alpha = 0.7, color = point_color) +
  ggplot2::facet_grid(~ group) +
  ggplot2::labs(x = expression(X[1]), y = paste0("PC", selected_pcs[2])) +
  custom_theme_without_legend +
  facet_header_selected

# make nonselected pc plot
nonselected_plt <- pca_plt_df %>%
  dplyr::filter(stringr::str_detect(group, paste0("PC", nonselected_pc))) %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = X1, y = color) +
  ggplot2::geom_point(size = 0.01, alpha = 0.7, color = point_color) +
  ggplot2::facet_grid(~ group) +
  ggplot2::labs(x = expression(X[1]), y = paste0("PC", nonselected_pc)) +
  custom_theme_without_legend +
  facet_header_nonselected

plt <- ss_plt + selected_plt1 + selected_plt2 + nonselected_plt + 
  plot_layout(nrow = 1, guides = "collect")

ggplot2::ggsave(filename = file.path(plots_dir, "appendix", "ss_h04_n500.pdf"), 
                plot = plt, units = 'in', width = 10, height = 2.5)
```

# Main Simulations: Figure 3

```{r}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")
metric <- "rocauc"

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(
        metric == "rocauc" ~ "AUROC",
        metric == "prauc" ~ "PRAUC"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, sprintf("real_data_artificial_y_sims_%s_%s_%s_errbars.pdf", 
                                   y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# Augmented fMRI Simulation: Figure 4

```{r}
fname <- file.path(results_dir, "r2f.fmri_augmented_dgp", 
                   "varying_sample_col_n_sample_row_n",
                   paste0("seed", seed), "results.csv")
results <- data.table::fread(fname) %>%
  reformat_results()
ps <- unique(results$sample_col_n)

plt_ls <- list()
for (p in ps) {
  plt <- results %>%
    dplyr::filter(sample_col_n == !!p) %>%
    plot_metrics(
      metric = "rocauc",
      x_str = "sample_row_n", 
      facet_str = NULL, 
      point_size = point_size, 
      line_size = line_size, 
      errbar_width = errbar_width, 
      manual_color_palette = manual_color_palette, 
      show_methods = show_methods, 
      method_labels = method_labels, 
      custom_theme = custom_theme, 
      inside_legend = FALSE
    ) +
    ggplot2::coord_cartesian(ylim = c(0.77, 1)) +
    ggplot2::labs(
      x = "Sample Size", y = "AUROC",
      color = "Method", alpha = "Method"
    )
  if (p != ps[1]) {
    plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
  }
  plt_ls[[as.character(p)]] <- plt
}

plt <- purrr::reduce(plt_ls, `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14),
    legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 1, guides = "collect")
ggplot2::ggsave(
  file.path(plots_dir, "fmri_augmented_sims.pdf"),
  plot = plt, units = "in", width = 12, height = 3
)

```

# Stability Simulations: Figure 5, 23-25
```{r}
# data resampling stability sims
y_dgp <- c('linear','lss','poly_int')
for(i in y_dgp){
  results <- read.csv(file.path(results_dir,paste0("stability_resampling_",i,".csv")))

  rankings <- results %>%
    dplyr::group_by(heritability,rho,fi,rep) %>%
    dplyr::summarise(rank = rank(-importance),
                     var = var)
  
  rankings$group <- 'NSig'
  if(i == 'linear'){
    rankings$group[rankings$var %in% 0:4] <- 'Sig'
    rankings$group[rankings$var %in% 5:24] <- 'C-NSig'
  } else{
    rankings$group[rankings$var %in% 0:5] <- 'Sig'
    rankings$group[rankings$var %in% 6:24] <- 'C-NSig'
  }

  rankings <- rankings %>%
    dplyr::group_by(group,rep,heritability,rho,fi) %>%
    dplyr::summarise(avgrank = mean(rank))
  
  methods = c('r2f','Permutation','MDI','MDI-oob','TreeSHAP')
  groups = c('Sig','C-NSig','NSig')
  rankings$group <- factor(rankings$group,levels = groups)
  rankings$fi <- factor(rankings$fi,levels = methods)

  ranks.sub$rho = factor(ranks.sub$rho,levels = c(0.5,0.8,0.99))
  levels(ranks.sub$rho) <- c('rho == 0.5','rho == 0.8','rho == 0.99')

  summary(ranks.sub$avgrank)
  a <- min(ranks.sub$avgrank)
  b <- max(ranks.sub$avgrank)

  p01_cor <- ggplot2::ggplot(ranks.sub[ranks.sub$heritability == 0.1,], 
             ggplot2::aes(x=group, y=avgrank, color=fi)) +
             ggplot2::geom_boxplot() +
             ggplot2::ylim(c(a,b)) +
             ggplot2::facet_grid(cols = ggplot2::vars(rho),
                                 labeller = ggplot2::label_parsed) +
             vthemes::theme_vmodern(
                size_preset = "medium", bg_color = "white", grid_color = "white",
                axis.title = ggplot2::element_text(size = 12, face = "plain"),
                legend.title = ggplot2::element_blank(),
                legend.text = ggplot2::element_text(size = 9),
                legend.text.align = 0,
                plot.title = ggplot2::element_blank()
             ) +
             ggplot2::scale_color_manual(values = manual_color_palette,
                       labels = c(expression(paste(r^2*f)),
                                  'Permutation',
                                  'MDI',
                                  'MDI-oob',
                                  'TreeSHAP')) +
             ggplot2::theme(panel.grid.major = ggplot2::element_line(colour = "#d9d9d9"),
                            panel.grid.major.x = ggplot2::element_blank(),
                            panel.grid.minor.x = ggplot2::element_blank(),
                            axis.line.y = ggplot2::element_blank(),
                            axis.ticks.y = ggplot2::element_blank()) +
             ggplot2::xlab('Feature Groups') +
             ggplot2::ylab('Avg Rank (PVE = 0.1)')
  
  p04_cor <- ggplot2::ggplot(ranks.sub[ranks.sub$heritability == 0.4,], 
                             ggplot2::aes(x=group, y=avgrank, color=fi)) +
    ggplot2::geom_boxplot() +
    ggplot2::ylim(c(a,b)) +
    ggplot2::facet_grid(cols = ggplot2::vars(rho),
                        labeller = ggplot2::label_parsed) +
    vthemes::theme_vmodern(
      size_preset = "medium", bg_color = "white", grid_color = "white",
      axis.title = ggplot2::element_text(size = 12, face = "plain"),
      legend.title = ggplot2::element_blank(),
      legend.text = ggplot2::element_text(size = 9),
      legend.text.align = 0,
      plot.title = ggplot2::element_blank()
    ) +
    ggplot2::scale_color_manual(values = manual_color_palette,
                                labels = c(expression(paste(r^2*f)),
                                           'Permutation',
                                           'MDI',
                                           'MDI-oob',
                                           'TreeSHAP')) +
    ggplot2::theme(panel.grid.major = ggplot2::element_line(colour = "#d9d9d9"),
                   panel.grid.major.x = ggplot2::element_blank(),
                   panel.grid.minor.x = ggplot2::element_blank(),
                   axis.line.y = ggplot2::element_blank(),
                   axis.ticks.y = ggplot2::element_blank(),
                   strip.text = ggplot2::element_blank()) +
    ggplot2::xlab('Feature Groups') +
    ggplot2::ylab('Avg Rank (PVE = 0.4)') +
    ggplot2::theme(legend.position="none")
  
  plt <- p01_cor + p04_cor + plot_layout(nrow = 2)
  ggplot2::ggsave(plt,
                  file.path(plots_dir,'appendix',
                            paste0('stability_resampling_sims_',i,'.pdf')),
                  width = 10, height = 6,units = 'in')
}

# data resampling stability sims
y_dgp <- 'linear'
for(i in y_dgp){
  results <- read.csv(file.path(results_dir,paste0("stability_algorithmic_",i,".csv")))

  rankings <- results %>%
    dplyr::group_by(min_samples_leaf,heritability,fi,rep) %>%
    dplyr::summarise(rank = rank(-importance),
                     var = var)
  
  
  rankings$group <- 'NSig'
  if(i == 'linear'){
    rankings$group[rankings$var %in% 0:4] <- 'Sig'
    rankings$group[rankings$var %in% 5:24] <- 'C-NSig'
  } else{
    rankings$group[rankings$var %in% 0:5] <- 'Sig'
    rankings$group[rankings$var %in% 6:24] <- 'C-NSig'
  }

  rankings <- rankings %>%
    dplyr::group_by(group,rep,min_samples_leaf,fi,heritability) %>%
    dplyr::summarise(avgrank = mean(rank))

  methods = c('r2f','Permutation','MDI','MDI-oob','TreeSHAP')
  groups = c('Sig','C-NSig','NSig')
  min_samples = unique(rankings$min_samples_leaf)
  
  rankings$group <- factor(rankings$group,levels = groups)
  rankings$fi <- factor(rankings$fi,levels = methods)
  rankings$min_samples_leaf <- factor(rankings$min_samples_leaf,levels = min_samples)
  rankings$rho <- 'rho == 0.8'
  
  summary(ranks.sub$avgrank)
  a <- min(ranks.sub$avgrank)
  b <- max(ranks.sub$avgrank)

  p01_alg <- ggplot2::ggplot(ranks.sub[ranks.sub$heritability == 0.1,], 
             ggplot2::aes(x=group, y=avgrank, color=fi)) +
             ggplot2::geom_boxplot() +
             ggplot2::ylim(c(a,b)) +
             ggplot2::facet_grid(cols = ggplot2::vars(rho),
                                 labeller = ggplot2::label_parsed) +
             vthemes::theme_vmodern(
                size_preset = "medium", bg_color = "white", grid_color = "white",
                axis.title = ggplot2::element_text(size = 12, face = "plain"),
                legend.title = ggplot2::element_blank(),
                legend.text = ggplot2::element_text(size = 9),
                legend.text.align = 0,
                plot.title = ggplot2::element_blank()
             ) +
             ggplot2::scale_color_manual(values = manual_color_palette,
                       labels = c(expression(paste(r^2*f)),
                                  'Permutation',
                                  'MDI',
                                  'MDI-oob',
                                  'TreeSHAP')) +
             ggplot2::theme(panel.grid.major = ggplot2::element_line(colour = "#d9d9d9"),
                            panel.grid.major.x = ggplot2::element_blank(),
                            panel.grid.minor.x = ggplot2::element_blank(),
                            axis.line.y = ggplot2::element_blank(),
                            axis.ticks.y = ggplot2::element_blank()) +
             ggplot2::xlab('Feature Groups') +
             ggplot2::ylab('Avg Rank (PVE = 0.1)')
  
  p04_alg <- ggplot2::ggplot(ranks.sub[ranks.sub$heritability == 0.4,], 
                             ggplot2::aes(x=group, y=avgrank, color=fi)) +
    ggplot2::geom_boxplot() +
    ggplot2::ylim(c(a,b)) +
    ggplot2::facet_grid(cols = ggplot2::vars(rho),
                        labeller = ggplot2::label_parsed) +
    vthemes::theme_vmodern(
      size_preset = "medium", bg_color = "white", grid_color = "white",
      axis.title = ggplot2::element_text(size = 12, face = "plain"),
      legend.title = ggplot2::element_blank(),
      legend.text = ggplot2::element_text(size = 9),
      legend.text.align = 0,
      plot.title = ggplot2::element_blank()
    ) +
    ggplot2::scale_color_manual(values = manual_color_palette,
                                labels = c(expression(paste(r^2*f)),
                                           'Permutation',
                                           'MDI',
                                           'MDI-oob',
                                           'TreeSHAP')) +
    ggplot2::theme(panel.grid.major = ggplot2::element_line(colour = "#d9d9d9"),
                   panel.grid.major.x = ggplot2::element_blank(),
                   panel.grid.minor.x = ggplot2::element_blank(),
                   axis.line.y = ggplot2::element_blank(),
                   axis.ticks.y = ggplot2::element_blank(),
                   strip.text = ggplot2::element_blank()) +
    ggplot2::xlab('Feature Groups') +
    ggplot2::ylab('Avg Rank (PVE = 0.4)') +
    ggplot2::theme(legend.position="none")
  
  plt <- p01_alg + p04_alg + plot_layout(nrow = 2)
  ggplot2::ggsave(plt,
                  file.path(plots_dir,'appendix',
                            paste0('stability_algorithmic_sims_',i,'.pdf')),
                  width = 5, height = 6,units = 'in')
}

```

# MDI Bias: Figure 6

```{r}
fname <- file.path("results_entropy.csv")
results <- data.table::fread(fname) %>%
  reformat_results()

plt_ls <- list()
for (metric in metrics_all) {
  metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                  metric == "prauc" ~ "AUPRC")
  plt <- results %>%
    plot_metrics(
      metric = metric,
      x_str = "n", 
      facet_str = NULL, 
      point_size = point_size, 
      line_size = line_size, 
      errbar_width = errbar_width, 
      manual_color_palette = manual_color_palette, 
      show_methods = show_methods, 
      method_labels = method_labels, 
      custom_theme = custom_theme, 
      inside_legend = FALSE
    ) +
    ggplot2::labs(
      x = "Sample Size", y = metric_name,
      color = "Method", alpha = "Method"
    )
  plt_ls[[metric]] <- plt
}

plt <- purrr::reduce(plt_ls, `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14),
    legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 1, guides = "collect")
ggplot2::ggsave(
  file.path(plots_dir, "appendix", "entropy_sims.pdf"),
  plot = plt, units = "in", width = 8.5, height = 3
)


```

# $r^2f$ Modeling Choices: Figure 8

```{r}
vary_param_name <- "heritability_sample_row_n"
cur_manual_color_palette <- c("black", "#ff9902", "#6caa52", "#4a86e8", "#a64d79")
cur_show_methods <- c("r2f", 
                      "r2f (Without Refit)", 
                      "r2f (Without Xk)", 
                      "r2f (AIC)", 
                      "r2f (CV)")
cur_method_labels <- c(bquote(~r^2*"f"), 
                       bquote(~r^2*"f (No Refit)"), 
                       bquote(~r^2*"f (No"~X[k]*")"), 
                       bquote(~r^2*"f (AIC)"), 
                       bquote(~r^2*"f (CV)"))
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")
metric <- "rocauc"

results_ls <- list()
for (y_model in y_models) {
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.r2f_algorithmic_choices.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

for (x_model in x_models) {
  plt_ls <- list()
  for (y_model in y_models) {
    plt_ls[[y_model]] <- list()
    for (h in heritabilities) {
      metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                      metric == "prauc" ~ "AUPRC")
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = cur_manual_color_palette, 
          show_methods = cur_show_methods, 
          method_labels = cur_method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        ) +
        ggplot2::theme(
          legend.position = c(0.75, 0.4),
          legend.background = ggplot2::element_rect(
            color = "slategray", size = .1
          )
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (y_model != y_models[length(y_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) |
          (y_model != y_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[y_model]][[as.character(h)]] <- plt
    }
    
    plt <- purrr::reduce(plt_ls[[y_model]], `+`) *
      ggplot2::theme(
        axis.text = ggplot2::element_text(size = 11),
        axis.title = ggplot2::element_text(size = 16, face = "plain"),
        legend.text = ggplot2::element_text(size = 14)
        # legend.title = ggplot2::element_text(face = "plain", size = 16)
      ) +
      plot_layout(nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix", 
                sprintf("model_choices_%s_%s_%s.pdf", y_model, x_model, metric)),
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# AUROC Appendix: Figures 9-12

```{r}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int", "linear_lss")
x_models <- c("german", "ukbb", "ccle_prot", "fmri")
metric <- "rocauc"

results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(
        metric == "rocauc" ~ "AUROC",
        metric == "prauc" ~ "PRAUC"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sims_appendix_%s_%s_%s_errbars.pdf", 
                        y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# AUPRC Appendix: Figures 13-16

```{r}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int", "linear_lss")
x_models <- c("german", "ukbb", "ccle_prot", "fmri")
metric <- "prauc"

results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(
        metric == "rocauc" ~ "AUROC",
        metric == "prauc" ~ "PRAUC"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sims_appendix_%s_%s_%s_errbars.pdf", 
                        y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# TPR Appendix: Figure 17

```{r}
y_models <- "linear"
x_models <- c("german", "ukbb")

results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

facet_vars <- c("PVE" = "heritability", "n" = "sample_row_n")
for (x_model in x_models) {
  for (y_model in y_models) {
    results <- results_ls[[y_model]][[x_model]]
    plt <- results %>%
      plot_tpr(facet_vars = facet_vars, 
               manual_color_palette = manual_color_palette, 
               show_methods = show_methods,
               method_labels = method_labels, 
               custom_theme = vthemes::theme_vmodern(size_preset = "medium")) +
      ggplot2::coord_cartesian(xlim = c(1, 10)) +
      ggplot2::scale_x_continuous(breaks = c(2, 4, 6, 8, 10)) +
      ggplot2::theme(panel.background = ggplot2::element_rect(fill = "white"), 
                     panel.grid.major = ggplot2::element_line(size = .1))
    ncols <- length(unique(results$sample_row_n))
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sims_appendix_%s_%s_tpr.pdf", 
                        y_model, x_model)), 
      plot = plt, units = "in", width = 12, height = 1.5 * ncols
    )
  }
}
```

# Misspecified Model Appendix: Figures 18-19

```{r}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name, "_omitted_vars"), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

for (metric in metrics_all) {
  plt_ls <- list()
  for (h in heritabilities) {
    plt_ls[[as.character(h)]] <- list()
    for (x_model in x_models) {
      plt_ls[[as.character(h)]][[x_model]] <- list()
      for (y_model in y_models) {
        sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
        sim_title <- dplyr::case_when(
          x_model == "ccle_prot" ~ "CCLE Protein",
          x_model == "ukbb" ~ "UK Biobank",
          x_model == "german" ~ "German Credit",
          x_model == "fmri" ~ "fMRI"
        )
        metric_name <- dplyr::case_when(
          metric == "rocauc" ~ "AUROC",
          metric == "prauc" ~ "PRAUC"
        )
        plt <- results_ls[[y_model]][[x_model]] %>%
          dplyr::filter(heritability == !!h) %>%
          plot_metrics(
            metric = metric,
            x_str = "sample_row_n", 
            facet_str = NULL, 
            point_size = point_size, 
            line_size = line_size, 
            errbar_width = errbar_width, 
            manual_color_palette = manual_color_palette, 
            show_methods = show_methods, 
            method_labels = method_labels, 
            custom_theme = custom_theme, 
            inside_legend = TRUE
          ) +
          ggplot2::labs(
            x = "Sample Size", y = metric_name,
            color = "Method", alpha = "Method",
            title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
          )
        if (h != heritabilities[1]) {
          plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
        }
        if (x_model != x_models[length(x_models)]) {
          plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
        }
        if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
          plt <- plt + ggplot2::guides(color = "none", alpha = "none")
        }
        plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
      }
    }
  }
  
  for (y_model in y_models) {
    for (x_model in x_models) {
      plt <- list()
      for (h in heritabilities) {
        cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
        if (identical(plt, list())) {
          plt <- cur_plt
        } else {
          plt <- plt + cur_plt
        }
      }
      plt <- plt +
        plot_layout(ncol = length(heritabilities), nrow = 1)
      ggplot2::ggsave(
        file.path(plots_dir, "appendix",
                  sprintf("real_data_artificial_y_omitted_vars_sims_%s_%s_%s_errbars.pdf", 
                          y_model, x_model, metric)), 
        plot = plt, units = "in", width = 14, height = 3
      )
    }
  }
}

```

# Varying Sparsity Appendix: Figure 20

```{r}
vary_param_names <- c("linear" = "heritability_s", 
                      "lss" = "heritability_m",
                      "poly_int" = "heritability_m")
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")
metric <- "rocauc"

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.sparsity_sims.", sim_name), 
                       paste0("varying_", vary_param_names[y_model]), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                      metric == "prauc" ~ "AUPRC")
      x_str <- ifelse(y_model == "linear", "s", "m")
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = x_str, 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = toupper(x_str), y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sparsity_sims_%s_%s_%s_errbars.pdf", 
                        y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# Logistic Regression Appendix: Figure 21

```{r}
vary_param_name <- "sample_row_n"
y_models <- "logistic"
x_models <- c("german", "ukbb", "ccle_prot", "fmri")

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name),
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (metric in metrics_all) {
  metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                  metric == "prauc" ~ "AUPRC")
  for (x_model in x_models) {
    plt_ls[[metric]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (x_model != x_models[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (metric == metrics_all[1]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((x_model != x_models[length(x_models)]) | (metric != metrics_all[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[metric]][[x_model]] <- plt
    }
  }
}

plt <- purrr::reduce(c(plt_ls$rocauc, plt_ls$prauc), `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14)
    # legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 2)
ggplot2::ggsave(
  file.path(plots_dir, "appendix", "logistic_dgp.pdf"),
  plot = plt, units = "in", width = 14, height = 6
)

```

# CART Simulation Appendix: Figure 22

```{r}
fname <- file.path(results_dir, "r2f.ccle_prot_cart_dgp", 
                   "varying_heritability_n",
                   paste0("seed", seed), "results.csv")
results <- data.table::fread(fname) %>%
  reformat_results()

plt_ls <- list()
for (metric in metrics_all) {
  metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                  metric == "prauc" ~ "AUPRC")
  plt_ls[[metric]] <- list()
  for (h in heritabilities) {
    plt <- results %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
    if (h != heritabilities[1]) {
      plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
    }
    plt_ls[[metric]][[as.character(h)]] <- plt
  }
}

plt <- purrr::reduce(c(plt_ls$rocauc, plt_ls$prauc), `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14),
    legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 2, guides = "collect")
ggplot2::ggsave(
  file.path(plots_dir, "appendix", "ccle_prot_cart_dgp.pdf"),
  plot = plt, units = "in", width = 14, height = 6
)

```


