---
title: "GMDI Simulation Results Summary"
author: ""
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: vthemes::vmodern
params:
  results_dir: 
    label: "Results directory"
    value: "/global/scratch/users/tiffanytang/feature_importance/results_final/"
    # value: "/global/scratch/users/tiffanytang/feature_importance/results/"
  seed:
    label: "Seed"
    value: 12345
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(magrittr)
library(patchwork)
chunk_idx <- 1

# set parameters
results_dir <- params$results_dir
seed <- params$seed
plots_dir <- file.path("plots")
tables_dir <- file.path("tables")
if (!dir.exists(file.path(plots_dir, "appendix"))) {
  dir.create(file.path(plots_dir, "appendix"), recursive = TRUE)
}

# miscellaneous helper variables
p_models <- list(
  ccle_prot = 214,
  ukbb = 500,
  german = 20,
  fmri = 500
)
heritabilities <- c(0.1, 0.2, 0.4, 0.8)
metrics_all <- c("rocauc", "prauc")

# plot options
point_size <- 2
line_size <- 1
errbar_width <- 0

# manual_color_palette <- NULL
# show_methods <- NULL
# method_labels <- ggplot2::waiver()

manual_color_palette_all <- NULL
show_methods_all <- NULL
method_labels_all <- ggplot2::waiver()
# E3E3E3, 264653, CBCBD4, 7E6551, #42007B
# manual_color_palette <- c("black", "orange", "#CC3399", "#218A1E", "#800000")
# show_methods <- c("GMDI_ridge", "Permutation", "MDI", "TreeSHAP", "MDI-oob")
# method_labels <- c("GMDI", "Permutation", "MDI", "TreeSHAP", "MDI-oob")
manual_color_palette <- c("black", "orange", "#71beb7", "#218a1e", "#cc3399")
show_methods <- c("GMDI_ridge", "Permutation", "MDI", "MDI-oob", "TreeSHAP")
method_labels <- c("GMDI", "Permutation", "MDI", "MDI-oob", "TreeSHAP")
# manual_color_palette <- c("black", "orange", "#71beb7", "#218a1e", "#7B5D44", "#cc3399")
# show_methods <- c("GMDI_ridge", "Permutation", "MDI", "MDI-oob", "MDA", "TreeSHAP")
# method_labels <- c("GMDI", "Permutation", "MDI", "MDI-oob", "MDA", "TreeSHAP")
# manual_color_palette <- c("black", "orange", "#CC3399", "#218A1E", "grey", "#800000")
# show_methods <- c("GMDI_ridge", "Permutation", "MDI", "MDI-oob", "MDA", "TreeSHAP")
# method_labels <- c("GMDI", "Permutation", "MDI", "MDI-oob", "MDA", "TreeSHAP")

custom_theme <- vthemes::theme_vmodern(
  size_preset = "medium", bg_color = "white", grid_color = "white",
  axis.ticks = ggplot2::element_line(size = ggplot2::rel(2), colour = "black"),
  axis.text = ggplot2::element_text(size = 14),
  axis.title = ggplot2::element_text(size = 20, face = "plain"),
  legend.text = ggplot2::element_text(size = 14),
  plot.title = ggplot2::element_blank()
  # plot.title = ggplot2::element_text(size = 12, face = "plain", hjust = 0.5)
)
custom_theme_with_legend <- vthemes::theme_vmodern(
  size_preset = "medium", bg_color = "white", grid_color = "white",
  axis.title = ggplot2::element_text(size = 12, face = "plain"),
  legend.text = ggplot2::element_text(size = 9),
  legend.text.align = 0,
  plot.title = ggplot2::element_blank()
)
custom_theme_without_legend <- vthemes::theme_vmodern(
  size_preset = "medium", bg_color = "white", grid_color = "white",
  axis.title = ggplot2::element_text(size = 12, face = "plain"),
  legend.title = ggplot2::element_blank(),
  legend.text = ggplot2::element_text(size = 9),
  legend.text.align = 0,
  plot.title = ggplot2::element_blank()
)

fig_height <- 6
fig_width <- 10

source("../../scripts/viz.R", chdir = TRUE)
```

# Main Simulations: Figure 3

```{r eval = FALSE}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")
metric <- "rocauc"

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(
        metric == "rocauc" ~ "AUROC",
        metric == "prauc" ~ "PRAUC"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, sprintf("real_data_artificial_y_sims_%s_%s_%s_errbars.pdf", 
                                   y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# Regression Simulations: Figure 3 {.tabset .tabset-vmodern}

```{r eval = TRUE, results = "asis"}
manual_color_palette <- c("black", "orange", "#71beb7", "#218a1e", "#7B5D44", "#cc3399")
show_methods <- c("GMDI_ridge_RF", "Permutation_RF", "MDI_RF", "MDI-oob_RF", "MDA_RF", "TreeSHAP_RF")
method_labels <- c("GMDI", "Permutation", "MDI", "MDI-oob", "MDA", "TreeSHAP")
alpha_values <- c(1, rep(0.4, length(method_labels) - 1))

vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss_3m_2r", "linear_lss_3m_2r", "hier_poly_3m_2r")
x_models <- c("enhancer", "ccle_rnaseq", "juvenile", "splicing")
metric <- "rocauc"
heritabilities <- c(0.05, 0.1, 0.2, 0.4)

# # read in data
# results_ls <- list()
# for (y_model in y_models) {
#   cat(sprintf("\n\n## %s {.tabset .tabset-pills .tabset-square}\n\n", y_model))
#   for (x_model in x_models) {
#     cat(sprintf("\n\n### %s \n\n", x_model))
#     sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
#     fname <- file.path(results_dir, paste0("gmdi.classification_sims.", sim_name), 
#                        paste0("varying_", vary_param_name), 
#                        paste0("seed", seed), "results")
#     if (file.exists(sprintf("%s.csv", fname))) {
#       results <- data.table::fread(sprintf("%s.csv", fname)) %>%
#         reformat_results()
#       saveRDS(results, sprintf("%s.rds", fname))
#       if (file.exists(sprintf("%s.rds", fname))) {
#         results <- readRDS(sprintf("%s.rds", fname))
#         if (length(setdiff(unique(results$fi), show_methods)) > 0) {
#           results <- data.table::fread(sprintf("%s.csv", fname)) %>%
#             reformat_results()
#           saveRDS(results, sprintf("%s.rds", fname))
#         }
#       } else {
#         results <- data.table::fread(sprintf("%s.csv", fname)) %>%
#           reformat_results()
#         saveRDS(results, sprintf("%s.rds", fname))
#       }
#       plt <- results %>%
#         plot_metrics(
#           metric = metric,
#           x_str = "sample_row_n",
#           facet_str = "frac_label_corruption_name",
#           point_size = point_size,
#           line_size = line_size,
#           errbar_width = errbar_width,
#           custom_theme = custom_theme
#         )
#       vthemes::subchunkify(plotly::ggplotly(plt), i = chunk_idx,
#                            fig_height = fig_height, fig_width = fig_width)
#       chunk_idx <- chunk_idx + 1
#     }
#   }
# }

# y_models <- c("logistic", "lss_3m_2r_logistic", "linear_lss_3m_2r_logistic", "hier_poly_3m_2r_logistic")
# x_models <- c("enhancer", "ccle_rnaseq")
# x_models <- c("juvenile", "splicing")
x_models <- c("enhancer", "ccle_rnaseq", "juvenile", "splicing")
y_models <- "linear_lss_3m_2r_logistic"
for (y_model in y_models) {
  for (x_model in x_models) {
    plt_ls <- list()
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    sim_title <- dplyr::case_when(
      x_model == "ccle_prot" ~ "CCLE Protein",
      x_model == "ccle_rnaseq" ~ "CCLE RNASeq",
      x_model == "ukbb" ~ "UK Biobank",
      x_model == "german" ~ "German Credit",
      x_model == "fmri" ~ "fMRI",
      x_model == "splicing" ~ "Splicing",
      x_model == "enhancer" ~ "Enhancer",
      x_model == "juvenile" ~ "Juvenile"
    )
    metric_name <- dplyr::case_when(
      metric == "rocauc" ~ "AUROC",
      metric == "prauc" ~ "PRAUC"
    )
    fname <- file.path(results_dir, paste0("gmdi.regressions_sims.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results")
    results <- data.table::fread(sprintf("%s.csv", fname)) %>%
      reformat_results()
    saveRDS(results, sprintf("%s.rds", fname))
    # if (file.exists(sprintf("%s.rds", fname))) {
    #   results <- readRDS(sprintf("%s.rds", fname))
    #   if (length(setdiff(show_methods, unique(results$method))) > 0) {
    #     results <- data.table::fread(sprintf("%s.csv", fname)) %>%
    #       reformat_results()
    #     saveRDS(results, sprintf("%s.rds", fname))
    #   }
    # } else {
    #   results <- data.table::fread(sprintf("%s.csv", fname)) %>%
    #     reformat_results()
    #   saveRDS(results, sprintf("%s.rds", fname))
    # }
    for (h in heritabilities) {
      plt <- results %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n",
          facet_str = NULL,
          point_size = point_size,
          line_size = line_size,
          errbar_width = errbar_width,
          manual_color_palette = manual_color_palette,
          show_methods = show_methods,
          method_labels = method_labels,
          alpha_values = alpha_values,
          legend_position = legend_position,
          custom_theme = custom_theme,
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if (!((h == heritabilities[length(heritabilities)]) & (x_model == x_models[1]) & (y_model == y_models[1]))) {
      # if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]] <- plt
    }
    plt <- patchwork::wrap_plots(plt_ls, nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, sprintf("regression_sims_%s_%s_%s_errbars.pdf",
                                   y_model, x_model, metric)),
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# Classification Simulations: Figure 3 {.tabset .tabset-vmodern}

```{r eval = TRUE, results = "asis"}
manual_color_palette <- c("black", "#7D2DFF", "orange", "#71beb7", "#218a1e", "#cc3399")
show_methods <- c("GMDI_ridge_RF", "GMDI_logistic_logloss_RF", "MDA_RF", "MDI_RF", "MDI-oob_RF", "TreeSHAP_RF")
method_labels <- c("GMDI (ridge)", "GMDI (logistic)", "MDA", "MDI", "MDI-oob", "TreeSHAP")
alpha_values <- c(1, 1, rep(0.4, length(method_labels) - 2))
legend_position <- c(0.73, 0.35)

vary_param_name <- "frac_label_corruption_sample_row_n"
y_models <- c("logistic", "lss_3m_2r_logistic", "linear_lss_3m_2r_logistic", "hier_poly_3m_2r_logistic")
x_models <- c("enhancer", "ccle_rnaseq", "juvenile", "splicing")
metric <- "rocauc"
frac_label_corruptions <- c("0.25", "0.15", "0.05", "0")

# read in data
results_ls <- list()
for (y_model in y_models) {
  cat(sprintf("\n\n## %s {.tabset .tabset-pills .tabset-square}\n\n", y_model))
  for (x_model in x_models) {
    cat(sprintf("\n\n### %s \n\n", x_model))
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("gmdi.classification_sims.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results")
    if (file.exists(sprintf("%s.csv", fname))) {
      results <- data.table::fread(sprintf("%s.csv", fname)) %>%
        reformat_results()
      saveRDS(results, sprintf("%s.rds", fname))
      # if (file.exists(sprintf("%s.rds", fname))) {
      #   results <- readRDS(sprintf("%s.rds", fname))
      #   if (length(setdiff(unique(results$fi), show_methods)) > 0) {
      #     results <- data.table::fread(sprintf("%s.csv", fname)) %>%
      #       reformat_results()
      #     saveRDS(results, sprintf("%s.rds", fname))
      #   }
      # } else {
      #   results <- data.table::fread(sprintf("%s.csv", fname)) %>%
      #     reformat_results()
      #   saveRDS(results, sprintf("%s.rds", fname))
      # }
      plt <- results %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n",
          facet_str = "frac_label_corruption_name",
          point_size = point_size,
          line_size = line_size,
          errbar_width = errbar_width,
          custom_theme = custom_theme
        )
      vthemes::subchunkify(plotly::ggplotly(plt), i = chunk_idx,
                           fig_height = fig_height, fig_width = fig_width)
      chunk_idx <- chunk_idx + 1
    }
  }
}

# y_models <- c("logistic", "lss_3m_2r_logistic", "linear_lss_3m_2r_logistic", "hier_poly_3m_2r_logistic")
# x_models <- c("enhancer", "ccle_rnaseq")
# x_models <- c("juvenile", "splicing")
x_models <- c("enhancer", "ccle_rnaseq", "juvenile", "splicing")
y_models <- "linear_lss_3m_2r_logistic"
for (y_model in y_models) {
  for (x_model in x_models) {
    plt_ls <- list()
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    sim_title <- dplyr::case_when(
      x_model == "ccle_prot" ~ "CCLE Protein",
      x_model == "ccle_rnaseq" ~ "CCLE RNASeq",
      x_model == "ukbb" ~ "UK Biobank",
      x_model == "german" ~ "German Credit",
      x_model == "fmri" ~ "fMRI",
      x_model == "splicing" ~ "Splicing",
      x_model == "enhancer" ~ "Enhancer",
      x_model == "juvenile" ~ "Juvenile"
    )
    metric_name <- dplyr::case_when(
      metric == "rocauc" ~ "AUROC",
      metric == "prauc" ~ "PRAUC"
    )
    fname <- file.path(results_dir, paste0("gmdi.classification_sims.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results")
    # results <- data.table::fread(sprintf("%s.csv", fname)) %>%
    #   reformat_results()
    # saveRDS(results, sprintf("%s.rds", fname))
    if (file.exists(sprintf("%s.rds", fname))) {
      results <- readRDS(sprintf("%s.rds", fname))
      if (length(setdiff(show_methods, unique(results$method))) > 0) {
        results <- data.table::fread(sprintf("%s.csv", fname)) %>%
          reformat_results()
        saveRDS(results, sprintf("%s.rds", fname))
      }
    } else {
      results <- data.table::fread(sprintf("%s.csv", fname)) %>%
        reformat_results()
      saveRDS(results, sprintf("%s.rds", fname))
    }
    for (h in frac_label_corruptions) {
      plt <- results %>%
        dplyr::filter(frac_label_corruption_name == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n",
          facet_str = NULL,
          point_size = point_size,
          line_size = line_size,
          errbar_width = errbar_width,
          manual_color_palette = manual_color_palette,
          show_methods = show_methods,
          method_labels = method_labels,
          alpha_values = alpha_values,
          legend_position = legend_position,
          custom_theme = custom_theme,
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != frac_label_corruptions[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if (!((h == frac_label_corruptions[length(frac_label_corruptions)]) & (x_model == x_models[1]) & (y_model == y_models[1]))) {
      # if ((h != frac_label_corruptions[length(frac_label_corruptions)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]] <- plt
    }
    plt <- patchwork::wrap_plots(plt_ls, nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, sprintf("classification_sims_%s_%s_%s_errbars.pdf",
                                   y_model, x_model, metric)),
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# Robust Simulations: Figure 3 {.tabset .tabset-vmodern}

```{r eval = TRUE, results = "asis"}
manual_color_palette <- c("black", "#7D2DFF", "orange", "#71beb7", "#218a1e", "#7B5D44", "#cc3399")
show_methods <- c("GMDI_ridge_RF", "GMDI_logistic_logloss_RF", "Permutation_RF", "MDI_RF", "MDI-oob_RF", "MDA_RF", "TreeSHAP_RF")
method_labels <- c("GMDI (ridge)", "GMDI (logistic)", "Permutation", "MDI", "MDI-oob", "MDA", "TreeSHAP")
alpha_values <- c(1, 1, rep(0.4, length(method_labels) - 2))
legend_position <- c(0.73, 0.4)

vary_param_name <- "corrupt_size_sample_row_n"
y_models <- c("linear", "lss_3m_2r", "linear_lss_3m_2r", "hier_poly_3m_2r")
x_models <- c("enhancer", "ccle_rnaseq", "juvenile", "splicing")
metric <- "rocauc"


seed <- 12345
y_model <- "linear_lss_3m_2r"
x_model <- "ccle_rnaseq"
mean_shifts <- c(10, 25, 50, 100)
vary_param_name <- "corrupt_size_sample_row_n"
plt_ls_all <- list()
for (y_model in y_models) {
  results_ls <- list()
  plt_ls <- list()
  
  for (mean_shift in mean_shifts) {
    sim_name <- sprintf("%s_%s_%sMS_robust_dgp", x_model, y_model, mean_shift)
    print(sim_name)
    fname <- file.path(results_dir, paste0("gmdi.robust_sims.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results")
    if (file.exists(sprintf("%s.csv", fname))) {
      results_ls[[as.character(mean_shift)]] <- data.table::fread(sprintf("%s.csv", fname)) %>%
        reformat_results()
    }
  }
  results <- dplyr::bind_rows(results_ls, .id = "mean_shift")
  
  for (corrupt_size in unique(results$corrupt_size_name)) {
    plt_df <- results %>%
      dplyr::filter((corrupt_size_name == !!corrupt_size) |
                      ((corrupt_size_name == 0) & (mean_shift == 10))) %>%
      dplyr::mutate(
        mean_shift = factor(ifelse(corrupt_size_name == 0, 0, mean_shift),
                            levels = as.character(c(0, sort(as.numeric(unique(mean_shift))))))
      )
    plt_ls[[as.character(corrupt_size)]] <- plt_df %>%
      plot_metrics(
        metric = metric,
        x_str = "sample_row_n",
        facet_str = "mean_shift",
        point_size = point_size,
        line_size = line_size,
        errbar_width = errbar_width,
        custom_theme = custom_theme
      ) +
      ggplot2::labs(y = corrupt_size)
  }
  
  print(patchwork::wrap_plots(plt_ls[-1], ncol = 1, guides = "collect"))
  plt_ls_all[[y_model]] <- patchwork::wrap_plots(plt_ls[-1], ncol = 1, guides = "collect")
}


# read in data
results_ls <- list()
for (y_model in y_models) {
  cat(sprintf("\n\n## %s {.tabset .tabset-pills .tabset-square}\n\n", y_model))
  for (x_model in x_models) {
    cat(sprintf("\n\n### %s \n\n", x_model))
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("gmdi.classification_sims.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results")
    if (file.exists(sprintf("%s.csv", fname))) {
      results <- data.table::fread(sprintf("%s.csv", fname)) %>%
        reformat_results()
      saveRDS(results, sprintf("%s.rds", fname))
      if (file.exists(sprintf("%s.rds", fname))) {
        results <- readRDS(sprintf("%s.rds", fname))
        if (length(setdiff(unique(results$fi), show_methods)) > 0) {
          results <- data.table::fread(sprintf("%s.csv", fname)) %>%
            reformat_results()
          saveRDS(results, sprintf("%s.rds", fname))
        }
      } else {
        results <- data.table::fread(sprintf("%s.csv", fname)) %>%
          reformat_results()
        saveRDS(results, sprintf("%s.rds", fname))
      }
      plt <- results %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n",
          facet_str = "frac_label_corruption_name",
          point_size = point_size,
          line_size = line_size,
          errbar_width = errbar_width,
          custom_theme = custom_theme
        )
      vthemes::subchunkify(plotly::ggplotly(plt), i = chunk_idx,
                           fig_height = fig_height, fig_width = fig_width)
      chunk_idx <- chunk_idx + 1
    }
  }
}

# y_models <- c("logistic", "lss_3m_2r_logistic", "linear_lss_3m_2r_logistic", "hier_poly_3m_2r_logistic")
# x_models <- c("enhancer", "ccle_rnaseq")
# x_models <- c("juvenile", "splicing")
x_models <- c("enhancer", "ccle_rnaseq", "juvenile", "splicing")
y_models <- "linear_lss_3m_2r_logistic"
for (y_model in y_models) {
  for (x_model in x_models) {
    plt_ls <- list()
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    sim_title <- dplyr::case_when(
      x_model == "ccle_prot" ~ "CCLE Protein",
      x_model == "ccle_rnaseq" ~ "CCLE RNASeq",
      x_model == "ukbb" ~ "UK Biobank",
      x_model == "german" ~ "German Credit",
      x_model == "fmri" ~ "fMRI",
      x_model == "splicing" ~ "Splicing",
      x_model == "enhancer" ~ "Enhancer",
      x_model == "juvenile" ~ "Juvenile"
    )
    metric_name <- dplyr::case_when(
      metric == "rocauc" ~ "AUROC",
      metric == "prauc" ~ "PRAUC"
    )
    fname <- file.path(results_dir, paste0("gmdi.classification_sims.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results")
    # results <- data.table::fread(sprintf("%s.csv", fname)) %>%
    #   reformat_results()
    # saveRDS(results, sprintf("%s.rds", fname))
    if (file.exists(sprintf("%s.rds", fname))) {
      results <- readRDS(sprintf("%s.rds", fname))
      if (length(setdiff(show_methods, unique(results$method))) > 0) {
        results <- data.table::fread(sprintf("%s.csv", fname)) %>%
          reformat_results()
        saveRDS(results, sprintf("%s.rds", fname))
      }
    } else {
      results <- data.table::fread(sprintf("%s.csv", fname)) %>%
        reformat_results()
      saveRDS(results, sprintf("%s.rds", fname))
    }
    for (h in frac_label_corruptions) {
      plt <- results %>%
        dplyr::filter(frac_label_corruption_name == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n",
          facet_str = NULL,
          point_size = point_size,
          line_size = line_size,
          errbar_width = errbar_width,
          manual_color_palette = manual_color_palette,
          show_methods = show_methods,
          method_labels = method_labels,
          alpha_values = alpha_values,
          legend_position = legend_position,
          custom_theme = custom_theme,
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != frac_label_corruptions[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if (!((h == frac_label_corruptions[length(frac_label_corruptions)]) & (x_model == x_models[1]) & (y_model == y_models[1]))) {
      # if ((h != frac_label_corruptions[length(frac_label_corruptions)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]] <- plt
    }
    plt <- patchwork::wrap_plots(plt_ls, nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, sprintf("classification_sims_%s_%s_%s_errbars.pdf",
                                   y_model, x_model, metric)),
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# Correlation Bias Simulations: Figure xx {.tabset .tabset-vmodern}

```{r corr-bias, eval = TRUE, results = "asis"}
# manual_color_palette_custom <- c("black", "orange", "#71beb7", "#218a1e", "#cc3399")
# show_methods_custom <- c("GMDI", "MDI-oob", "MDI", "Permutation",  "TreeSHAP")
# method_labels_custom <- c("GMDI", "MDI-oob", "MDI", "Permutation", "TreeSHAP")
# manual_color_palette_custom <- c("black", "#218a1e", "#7B5D44", "#71beb7", "orange", "#cc3399")
# show_methods_custom <- c("GMDI", "MDI-oob", "MDA", "MDI", "Permutation",  "TreeSHAP")
# method_labels_custom <- c("GMDI", "MDI-oob", "MDA", "MDI", "Permutation", "TreeSHAP")
manual_color_palette_custom <- c("black", "#218a1e", "orange", "#71beb7", "#cc3399")
show_methods_custom <- c("GMDI", "MDI-oob", "MDA", "MDI",  "TreeSHAP")
method_labels_custom <- c("GMDI", "MDI-oob", "MDA", "MDI", "TreeSHAP")

custom_color_palette <- c("#38761d", "#9dc89b", "#991500")
fpath <- "gmdi.mdi_bias_sims"
heritabilities <- c(0.1, 0.4)
y_dgp <- "partial_linear_lss"
sim_setup <- "n250_p100_balanced_final"
sim_name <- sprintf("%s.correlation_sims_%s.normal_block_cor_%s_dgp", fpath, sim_setup, y_dgp)
fname <- file.path(
  results_dir, 
  sim_name,
  "varying_heritability_rho",
  sprintf("seed%s", seed),
  "results.csv"
)
results <- data.table::fread(fname) %>%
  dplyr::filter(heritability_name %in% heritabilities)

n <- 250
p <- 100
sig_ids <- 0:5
cnsig_ids <- 6:49
nreps <- length(unique(results$rep))

plt_base <- plot_perturbation_stability(
  results,
  facet_rows = "heritability_name",
  facet_cols = "rho_name",
  param_name = NULL,
  sig_ids = sig_ids,
  cnsig_ids = cnsig_ids,
  plot_types = "errbar",
  manual_color_palette = manual_color_palette_custom,
  show_methods = show_methods_custom,
  method_labels = method_labels_custom
)

for (idx in 1:length(heritabilities)) {
  h <- heritabilities[idx]
  cat(sprintf("\n\n## PVE = %s {.tabset .tabset-pills .tabset-square}\n\n", h))
  plt_df <- plt_base$agg[[idx]]$data
  plt_ls <- list()
  for (method in method_labels_custom) {
    plt_ls[[method]] <- plt_df %>%
      dplyr::filter(fi == method) %>%
      ggplot2::ggplot() +
      ggplot2::aes(x = rho_name, y = .mean, color = group) +
      ggplot2::geom_line() +
      ggplot2::geom_ribbon(
        ggplot2::aes(x = rho_name, 
                     ymin = .mean - (.sd / sqrt(nreps)), 
                     ymax = .mean + (.sd / sqrt(nreps)), 
                     fill = group), 
        inherit.aes = FALSE, alpha = 0.2
      ) +
      ggplot2::labs(
        x = expression("Correlation ("*rho*")"), 
        y = "Average Rank", 
        color = "Feature\nGroup", 
        title = method
      ) +
      ggplot2::coord_cartesian(
        ylim = c(min(plt_df$.mean) - 3, max(plt_df$.mean) + 3)
      ) +
      ggplot2::scale_color_manual(
        values = custom_color_palette, guide = ggplot2::guide_legend(reverse = TRUE)
      ) +
      ggplot2::scale_fill_manual(
        values = custom_color_palette, guide = ggplot2::guide_legend(reverse = TRUE)
      ) +
      # ggplot2::scale_x_continuous(
      #   labels = as.character(c(0.5, 0.6, 0.7, 0.8, 0.9, 1))
      # ) +
      ggplot2::guides(fill = "none", linetype = "none") + #, color = "none") +
      vthemes::theme_vmodern(
        size_preset = "medium", bg_color = "white", grid_color = "white",
        axis.ticks = ggplot2::element_line(size = ggplot2::rel(2), colour = "black"),
        axis.text = ggplot2::element_text(size = 14),
        axis.title = ggplot2::element_text(size = 18, face = "plain"),
        legend.text = ggplot2::element_text(size = 14),
        legend.title = ggplot2::element_text(size = 18),
        plot.title = ggplot2::element_text(size = 20, face = "bold", hjust = 0.5)
      )
    if (method != method_labels_custom[1]) {
      plt_ls[[method]] <- plt_ls[[method]] +
        ggplot2::theme(axis.title.y = ggplot2::element_blank(),
                       axis.ticks.y = ggplot2::element_blank(),
                       axis.text.y = ggplot2::element_blank())
    }
  }
  
  # plt <- patchwork::wrap_plots(
  #   c(list(plot_spacer()), plt_ls[c("GMDI", "MDI-oob")], list(plot_spacer())), 
  #   widths = c(0.5, 1, 1, 0.5)
  # ) /
  #   patchwork::wrap_plots(plt_ls[c("MDI", "Permutation", "TreeSHAP")]) +
  #   patchwork::plot_layout(guides = "collect")
  # ggplot2::ggsave(plt, filename = file.path(plots_dir, sprintf("correlation_sim_%s_pve%s.pdf", y_dgp, h)), 
  #                 height = fig_height * 1.2, width = fig_width * .3 * length(show_methods_custom))
  
  plt_wide <- patchwork::wrap_plots(plt_ls, guides = "collect", nrow = 1)
  # plt_wide <- patchwork::wrap_plots(plt_ls, guides = "collect", nrow = 1)
  ggplot2::ggsave(plt_wide, filename = file.path(plots_dir, sprintf("correlation_sim_%s_pve%s_wide.pdf", y_dgp, h)),
                  # height = fig_height * .55, width = fig_width * .25 * length(show_methods_custom))
                  height = fig_height * .55, width = fig_width * .3 * length(show_methods_custom))
  
  plt_legend <- plt_df %>%
    dplyr::filter(fi == method) %>%
    ggplot2::ggplot() +
    ggplot2::aes(x = rho_name, y = .mean, color = group) +
    ggplot2::geom_line() +
    ggplot2::geom_ribbon(
      ggplot2::aes(x = rho_name, 
                   ymin = .mean - (.sd / sqrt(nreps)), 
                   ymax = .mean + (.sd / sqrt(nreps)), 
                   fill = group), 
      inherit.aes = FALSE, alpha = 0.2
    ) +
    ggplot2::labs(
      x = expression("Correlation ("*rho*")"), 
      y = "Average Rank", 
      color = "Feature Group", 
      title = method
    ) +
    ggplot2::coord_cartesian(
      ylim = c(min(plt_df$.mean) - 3, max(plt_df$.mean) + 3)
    ) +
    ggplot2::scale_color_manual(
      values = custom_color_palette, guide = ggplot2::guide_legend(reverse = TRUE)
    ) +
    ggplot2::scale_fill_manual(
      values = custom_color_palette, guide = ggplot2::guide_legend(reverse = TRUE)
    ) +
    # ggplot2::scale_x_continuous(
    #   labels = as.character(c(0.5, 0.6, 0.7, 0.8, 0.9, 1))
    # ) +
    ggplot2::guides(fill = "none", linetype = "none",
                    color = ggplot2::guide_legend(override.aes = list(size = 2))) +
    vthemes::theme_vmodern(
      size_preset = "medium", bg_color = "white", grid_color = "white",
      axis.ticks = ggplot2::element_line(size = ggplot2::rel(2), colour = "black"),
      axis.text = ggplot2::element_text(size = 14),
      axis.title = ggplot2::element_text(size = 18, face = "plain"),
      legend.text = ggplot2::element_text(size = 14),
      legend.title = ggplot2::element_text(size = 18),
      legend.position = "bottom",
      legend.key.width = grid::unit(1, "cm"),
      plot.title = ggplot2::element_text(size = 20, face = "bold", hjust = 0.5)
    )
  ggplot2::ggsave(grid::grid.draw(cowplot::get_legend(plt_legend)),
                  filename = file.path(plots_dir, "correlation_sim_legend.pdf"))
  
  vthemes::subchunkify(
    plt, i = paste0(sim_name, idx), fig_height = fig_height, fig_width = fig_width
  )
}

```


```{r eval = FALSE, results = "asis"}
manual_color_palette_new <- c("black", "orange", "#71beb7", "#218a1e", "#cc3399")
show_methods_new <- c("GMDI_ridge_drop", "MDI-oob", "MDI", "Permutation",  "TreeSHAP")
method_labels_new <- c("GMDI", "MDI-oob", "MDI", "Permutation", "TreeSHAP")
fpath <- "gmdi.mdi_bias_sims"

cat("\n\n## Final Plot {.tabset .tabset-pills .tabset-square}\n\n")
y_dgp <- "partial_linear_lss"
sim_setup <- "n250_p100_balanced_final"
sim_name <- sprintf("%s.correlation_sims_%s.normal_block_cor_%s_dgp", fpath, sim_setup, y_dgp)
fname <- file.path(
  results_dir, 
  sim_name,
  "varying_heritability_rho",
  sprintf("seed%s", seed),
  "results.csv"
)
results <- data.table::fread(fname) %>%
  dplyr::filter(heritability_name %in% c(0.1, 0.4))

n <- as.numeric(stringr::str_extract(sim_setup, "(?<=n)[0-9]+"))
p <- as.numeric(stringr::str_extract(sim_setup, "(?<=p)[0-9]+"))
balanced <- stringr::str_detect(sim_setup, "balanced")
if (y_dgp == "linear") {
  nsig <- 4
} else {
  nsig <- 5
}

sig_ids <- 0:nsig
if (balanced) {
  cnsig_ids <- nsig:(p / 2 - 1)
} else if (p == 20) {
  cnsig_ids <- nsig:9
} else {
  cnsig_ids <- nsig:24
}

plt_base <- plot_perturbation_stability(
  results,
  facet_rows = "heritability_name",
  facet_cols = "rho_name",
  param_name = NULL,
  sig_ids = sig_ids,
  cnsig_ids = cnsig_ids,
  plot_types = "errbar",
  # manual_color_palette = manual_color_palette_new,
  # show_methods = show_methods_new,
  # method_labels = method_labels_new,
  manual_color_palette = manual_color_palette_all,
  show_methods = show_methods_all,
  method_labels = method_labels_all
)

plt_df <- plt_base$agg[[1]]$data
plt_ls <- list()
# for (method in method_labels_new) {
# for (method in unique(plt_df$fi)) {
for (method in keep_methods) {
  plt_ls[[method]] <- plt_df %>%
    dplyr::filter(fi == method) %>%
    ggplot2::ggplot() +
    ggplot2::aes(x = rho_name, y = .mean, color = group) +
    # ggplot2::facet_wrap(~ fi) +
    ggplot2::geom_line() +
    ggplot2::geom_ribbon(
      ggplot2::aes(x = rho_name, ymin = .mean - (.sd / sqrt(50)), ymax = .mean + (.sd / sqrt(50)), fill = group), inherit.aes = FALSE, alpha = 0.2
    ) +
    ggplot2::labs(x = expression("Correlation ("*rho*")"), y = "Average Rank", color = "Feature\nGroup", title = method) +
    ggplot2::coord_cartesian(ylim = c(25, 70)) +
    ggplot2::scale_color_manual(values = c("#38761d", "#9dc89b", "#991500"),
                                guide = ggplot2::guide_legend(reverse = TRUE)) +
    ggplot2::scale_fill_manual(values = c("#38761d", "#9dc89b", "#991500"),
                               guide = ggplot2::guide_legend(reverse = TRUE)) +
    ggplot2::guides(fill = "none", linetype = "none") +
    vthemes::theme_vmodern(
      size_preset = "medium", bg_color = "white", grid_color = "white",
      axis.ticks = ggplot2::element_line(size = ggplot2::rel(2), colour = "black"),
      axis.text = ggplot2::element_text(size = 14),
      axis.title = ggplot2::element_text(size = 18, face = "plain"),
      legend.text = ggplot2::element_text(size = 14),
      legend.title = ggplot2::element_text(size = 18),
      plot.title = ggplot2::element_text(size = 20, face = "bold", hjust = 0.5)
    )
  if (method != method_labels_new[1]) {
    plt_ls[[method]] <- plt_ls[[method]] +
      ggplot2::theme(
        axis.title.y = ggplot2::element_blank()
      )
  }
}

# patchwork::wrap_plots(plt_ls, guides = "collect")

plt <- patchwork::wrap_plots(c(list(plot_spacer()), plt_ls[c("GMDI", "MDI-oob")], list(plot_spacer())), widths = c(0.5, 1, 1, 0.5)) /
  patchwork::wrap_plots(plt_ls[c("MDI", "Permutation", "TreeSHAP")]) +
  patchwork::plot_layout(guides = "collect")
plt

ggplot2::ggsave(plt, filename = file.path(plots_dir, sprintf("correlation_sim_%s_pve01.pdf", y_dgp)), 
                height = fig_height * 1.2, width = fig_width * 1.5)

plt <- patchwork::wrap_plots(plt_ls, guides = "collect", nrow = 1)
ggplot2::ggsave(plt, filename = file.path(plots_dir, sprintf("correlation_sim_%s_pve01_wide.pdf", y_dgp)), 
                height = fig_height * .5, width = fig_width * 1.5)

plt_df <- plt_base$agg[[2]]$data
plt_ls <- list()
for (method in method_labels_new) {
  plt_ls[[method]] <- plt_df %>%
    dplyr::filter(fi == method) %>%
    ggplot2::ggplot() +
    ggplot2::aes(x = rho_name, y = .mean, color = group) +
    # ggplot2::facet_wrap(~ fi) +
    ggplot2::geom_line() +
    ggplot2::geom_ribbon(
      ggplot2::aes(x = rho_name, ymin = .mean - (.sd / sqrt(50)), ymax = .mean + (.sd / sqrt(50)), fill = group), inherit.aes = FALSE, alpha = 0.2
    ) +
    ggplot2::labs(x = expression("Correlation ("*rho*")"), y = "Average Rank", color = "Feature\nGroup", title = method) +
    ggplot2::coord_cartesian(ylim = c(12, 75)) +
    ggplot2::scale_color_manual(values = c("#38761d", "#9dc89b", "#991500"),
                                guide = ggplot2::guide_legend(reverse = TRUE)) +
    ggplot2::scale_fill_manual(values = c("#38761d", "#9dc89b", "#991500"),
                               guide = ggplot2::guide_legend(reverse = TRUE)) +
    ggplot2::guides(fill = "none", linetype = "none") +
    vthemes::theme_vmodern(
      size_preset = "medium", bg_color = "white", grid_color = "white",
      axis.ticks = ggplot2::element_line(size = ggplot2::rel(2), colour = "black"),
      axis.text = ggplot2::element_text(size = 14),
      axis.title = ggplot2::element_text(size = 18, face = "plain"),
      legend.text = ggplot2::element_text(size = 14),
      legend.title = ggplot2::element_text(size = 18),
      plot.title = ggplot2::element_text(size = 20, face = "bold", hjust = 0.5)
    )
  if (method != method_labels_new[1]) {
    plt_ls[[method]] <- plt_ls[[method]] +
      ggplot2::theme(
        axis.title.y = ggplot2::element_blank()
      )
  }
}

plt <- patchwork::wrap_plots(c(list(plot_spacer()), plt_ls[c("GMDI", "MDI-oob")], list(plot_spacer())), widths = c(0.5, 1, 1, 0.5)) /
  patchwork::wrap_plots(plt_ls[c("MDI", "Permutation", "TreeSHAP")]) +
  patchwork::plot_layout(guides = "collect")
plt

ggplot2::ggsave(plt, filename = file.path(plots_dir, sprintf("correlation_sim_%s_pve04.pdf", y_dgp)), 
                height = fig_height * 1.2, width = fig_width * 1.5)

plt <- patchwork::wrap_plots(plt_ls, guides = "collect", nrow = 1)
ggplot2::ggsave(plt, filename = file.path(plots_dir, sprintf("correlation_sim_%s_pve04_wide.pdf", y_dgp)), 
                height = fig_height * .5, width = fig_width * 1.5)

```

```{r eval = FALSE, results = "asis"}
manual_color_palette_new <- c("black", "orange", "#71beb7", "#218a1e", "#cc3399")
show_methods_new <- c("GMDI_ridge", "MDI-oob", "MDI", "Permutation",  "TreeSHAP")
method_labels_new <- c("GMDI", "MDI-oob", "MDI", "Permutation", "TreeSHAP")
fpath <- "gmdi.mdi_bias_sims"
# y_dgps <- c("linear")
# sim_setups <- c("n250_p100_balanced")
y_dgps <- c("linear")#, "lss", "partial_linear_lss", "poly_int")
sim_setups <- c("n250_p20", "n500_p50", "n250_p50", "n250_p100", "n250_p100_balanced", "n250_p500", "n250_p500_balanced", "n250_p1000")#, "n472_p5000")
for (y_dgp in y_dgps) {
  cat(sprintf("\n\n## %s {.tabset .tabset-pills .tabset-square}\n\n", y_dgp))
  for (sim_setup in sim_setups) {
    cat(sprintf("\n\n### %s {.tabset .tabset-pills .tabset-circle}\n\n", sim_setup))
    sim_name <- sprintf("%s.correlation_sims_%s.normal_block_cor_%s_dgp", fpath, sim_setup, y_dgp)
    fname <- file.path(
      results_dir, 
      sim_name,
      "varying_heritability_rho",
      sprintf("seed%s", seed),
      "results.csv"
    )
    if (!file.exists(fname)) {
      next
    }
    results <- data.table::fread(fname) %>%
      dplyr::filter(rho_name %in% c(0.8, 0.9, 0.99),
                    heritability_name %in% c(0.1, 0.4))
    
    n <- as.numeric(stringr::str_extract(sim_setup, "(?<=n)[0-9]+"))
    p <- as.numeric(stringr::str_extract(sim_setup, "(?<=p)[0-9]+"))
    balanced <- stringr::str_detect(sim_setup, "balanced")
    if (y_dgp == "linear") {
      nsig <- 4
    } else {
      nsig <- 5
    }
    
    sig_ids <- 0:nsig
    if (balanced) {
      cnsig_ids <- nsig:(p / 2 - 1)
    } else if (p == 20) {
      cnsig_ids <- nsig:9
    } else {
      cnsig_ids <- nsig:24
    }
    # print(sprintf("%s: %s, %s", sim_setup, nsig, max(cnsig_ids)))
    
    plt <- plot_perturbation_stability(
      # results %>% dplyr::filter(rho_name == RHO),
      results,
      facet_rows = "heritability_name",
      facet_cols = "rho_name",
      param_name = NULL,
      sig_ids = sig_ids,
      cnsig_ids = cnsig_ids,
      plot_types = "errbar",
      manual_color_palette = manual_color_palette_new,
      show_methods = show_methods_new,
      method_labels = method_labels_new
    )
    # print(plt$agg)
    # readline(prompt = "Press [enter]")
    vthemes::subchunkify(
      plt$agg, i = sim_name, fig_height = fig_height, fig_width = fig_width
    )
  }
}

cat(sprintf("\n\n## Final Plot {.tabset .tabset-pills .tabset-square}\n\n", y_dgp))
y_dgp <- "partial_linear_lss"
# y_dgp <- "linear"
sim_setup <- "n250_p100_balanced"
sim_name <- sprintf("%s.correlation_sims_%s.normal_block_cor_%s_dgp", fpath, sim_setup, y_dgp)
fname <- file.path(
  results_dir, 
  sim_name,
  "varying_heritability_rho",
  sprintf("seed%s", seed),
  "results.csv"
)
results <- data.table::fread(fname) %>%
  dplyr::filter(heritability_name %in% c(0.1, 0.4))
# results <- data.table::fread(fname) %>%
#   dplyr::filter(rho_name %in% c(0.8, 0.9, 0.99),
#                 heritability_name %in% c(0.1, 0.4))

n <- as.numeric(stringr::str_extract(sim_setup, "(?<=n)[0-9]+"))
p <- as.numeric(stringr::str_extract(sim_setup, "(?<=p)[0-9]+"))
balanced <- stringr::str_detect(sim_setup, "balanced")
if (y_dgp == "linear") {
  nsig <- 4
} else {
  nsig <- 5
}

sig_ids <- 0:nsig
if (balanced) {
  cnsig_ids <- nsig:(p / 2 - 1)
} else if (p == 20) {
  cnsig_ids <- nsig:9
} else {
  cnsig_ids <- nsig:24
}

plt <- plot_perturbation_stability(
  results,
  facet_rows = "heritability_name",
  facet_cols = "rho_name",
  param_name = NULL,
  sig_ids = sig_ids,
  cnsig_ids = cnsig_ids,
  plot_types = "errbar",
  # manual_color_palette = manual_color_palette_new,
  # show_methods = show_methods_new,
  # method_labels = method_labels_new,
  manual_color_palette = manual_color_palette_all,
  show_methods = show_methods_all,
  method_labels = method_labels_all
)

plt_df <- dplyr::bind_rows(
  plt$agg[[1]]$data %>% dplyr::mutate(pve = "0.1"),
  # plt$agg[[2]]$data %>% dplyr::mutate(pve = "0.4")
) 
plt_final <- plt_df %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = rho_name, y = .mean, color = group, linetype = pve) +
  ggplot2::facet_wrap(~ fi) +
  ggplot2::geom_line() +
  ggplot2::geom_ribbon(
    ggplot2::aes(x = rho_name, ymin = .mean - (.sd / sqrt(50)), ymax = .mean + (.sd / sqrt(50)), fill = group, linetype = pve), inherit.aes = FALSE, alpha = 0.2,
    data = plt_df
  ) +
  ggplot2::labs(x = "Correlation", y = "Average Rank", color = "Feature Group", linetype = "PVE") +
  ggplot2::scale_color_manual(values = c("#38761d", "#9dc89b", "#991500")) +
  ggplot2::scale_fill_manual(values = c("#38761d", "#9dc89b", "#991500")) +
  vthemes::theme_vmodern()

# plt1 <- plt$agg[[1]]$data %>%
#   dplyr::mutate(
#     rho_name = sprintf("Correlation = %s", rho_name),
#     group = dplyr::case_when(
#       as.character(group) == "Sig" ~ "Signal",
#       as.character(group) == "C-NSig" ~ "Correlated Non-Signal",
#       as.character(group) == "NSig" ~ "Uncorrelated Non-Signal"
#     ) %>%
#       factor(levels = c("Signal", "Correlated Non-Signal", "Uncorrelated Non-Signal"))
#   ) %>%
#   ggplot2::ggplot() +
#   ggplot2::aes(x = fi, ymin = .mean - .sd, ymax = .mean + .sd, color = group) +
#   ggplot2::geom_errorbar(
#     position = ggplot2::position_dodge(.5), width = 0.3
#   ) +
#   ggplot2::facet_grid(~ rho_name) +
#   ggplot2::labs(x = "Method", y = "Avg Rank (PVE = 0.1)", color = "Feature Group") +
#   vthemes::theme_vmodern()
# plt2 <- plt$agg[[2]]$data %>%
#   dplyr::mutate(
#     rho_name = sprintf("Correlation = %s", rho_name),
#     group = dplyr::case_when(
#       as.character(group) == "Sig" ~ "Signal",
#       as.character(group) == "C-NSig" ~ "Correlated Non-Signal",
#       as.character(group) == "NSig" ~ "Uncorrelated Non-Signal"
#     ) %>%
#       factor(levels = c("Signal", "Correlated Non-Signal", "Uncorrelated Non-Signal"))
#   ) %>%
#   ggplot2::ggplot() +
#   ggplot2::aes(x = fi, ymin = .mean - .sd, ymax = .mean + .sd, color = group) +
#   ggplot2::geom_errorbar(
#     position = ggplot2::position_dodge(.5), width = 0.3
#   ) +
#   ggplot2::facet_grid(~ rho_name) +
#   ggplot2::labs(x = "Method", y = "Avg Rank (PVE = 0.4)", color = "Feature Group") +
#   vthemes::theme_vmodern()
# plt1 + plt2 + patchwork::plot_layout(nrow = 2, ncol = 1, guides = "collect")

plt_df <- dplyr::bind_rows(
  plt$agg[[1]]$data %>% dplyr::mutate(pve = "PVE = 0.1"),
  # plt$agg[[2]]$data %>% dplyr::mutate(pve = "PVE = 0.4"),
) %>%
  dplyr::mutate(
    rho_name = sprintf("Correlation = %s", rho_name),
    # group = dplyr::case_when(
    #   as.character(group) == "Sig" ~ "Signal",
    #   as.character(group) == "C-NSig" ~ "Correlated Non-Signal",
    #   as.character(group) == "NSig" ~ "Uncorrelated Non-Signal"
    # ) %>%
    #   factor(levels = c("Signal", "Correlated Non-Signal", "Uncorrelated Non-Signal")),
    fi = forcats::fct_rev(fi)
  )
range_df <- plt_df %>%
  dplyr::group_by(fi, pve, rho_name) %>%
  dplyr::summarise(min = min(.mean), max = max(.mean)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(
    fi = factor(as.character(fi), levels = levels(plt_df$fi))
  )
plt_final <- ggplot2::ggplot(plt_df) +
  ggplot2::aes(x = .mean, y = fi, color = group) +
  ggplot2::geom_segment(
    ggplot2::aes(x = min, xend = max, y = fi, yend = fi), data = range_df,
    inherit.aes = FALSE, size = 1, color = "darkgray"
  ) +
  ggplot2::geom_point(size = 8) +
  ggplot2::facet_grid(~ rho_name) +
  # ggplot2::facet_grid(pve ~ rho_name) +
  ggplot2::labs(y = "Method", x = "Average Rank", color = "Feature Group") +
  ggplot2::scale_color_manual(values = c("#38761d", "#9dc89b", "#991500")) +
  vthemes::theme_vmodern(
    grid_color = "grey80",
    panel.grid.major.x = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank(),
    axis.line = ggplot2::element_blank(),
    size_preset = "large"
  )
vthemes::subchunkify(
  plt_final, i = paste0(sim_name, "-final"), fig_height = fig_height, fig_width = fig_width
)
ggplot2::ggsave(plt_final, filename = file.path(plots_dir, sprintf("correlation_sim_%s_pve01.pdf", y_dgp)), 
                height = fig_height * .7, width = fig_width * 1.5)

plt_df <- dplyr::bind_rows(
  # plt$agg[[1]]$data %>% dplyr::mutate(pve = "PVE = 0.1"),
  plt$agg[[2]]$data %>% dplyr::mutate(pve = "PVE = 0.4"),
) %>%
  dplyr::mutate(
    rho_name = sprintf("Correlation = %s", rho_name),
    # group = dplyr::case_when(
    #   as.character(group) == "Sig" ~ "Signal",
    #   as.character(group) == "C-NSig" ~ "Correlated Non-Signal",
    #   as.character(group) == "NSig" ~ "Uncorrelated Non-Signal"
    # ) %>%
    #   factor(levels = c("Signal", "Correlated Non-Signal", "Uncorrelated Non-Signal")),
    fi = forcats::fct_rev(fi)
  )
range_df <- plt_df %>%
  dplyr::group_by(fi, pve, rho_name) %>%
  dplyr::summarise(min = min(.mean), max = max(.mean)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(
    fi = factor(as.character(fi), levels = levels(plt_df$fi))
  )
plt_final <- ggplot2::ggplot(plt_df) +
  ggplot2::aes(x = .mean, y = fi, color = group) +
  ggplot2::geom_segment(
    ggplot2::aes(x = min, xend = max, y = fi, yend = fi), data = range_df,
    inherit.aes = FALSE, size = 1, color = "darkgray"
  ) +
  ggplot2::geom_point(size = 8) +
  ggplot2::facet_grid(~ rho_name) +
  # ggplot2::facet_grid(pve ~ rho_name) +
  ggplot2::labs(y = "Method", x = "Average Rank", color = "Feature Group") +
  ggplot2::scale_color_manual(values = c("#38761d", "#9dc89b", "#991500")) +
  vthemes::theme_vmodern(
    grid_color = "grey80",
    panel.grid.major.x = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank(),
    axis.line = ggplot2::element_blank(),
    size_preset = "large"
  )
# vthemes::subchunkify(
#   plt_final, i = paste0(sim_name, "-final"), fig_height = fig_height, fig_width = fig_width
# )
ggplot2::ggsave(plt_final, filename = file.path(plots_dir, sprintf("correlation_sim_%s_pve04.pdf", y_dgp)), 
                height = fig_height * .7, width = fig_width * 1.5)
```

```{r corr-bias-old, eval = FALSE, results = "asis"}

fpath <- "gmdi.mdi_bias_sims"
y_dgps <- c("linear")#, "lss", "partial_linear_lss", "poly_int")
sim_setups <- c("n250_p20", "n500_p50", "n250_p50", "n250_p100", "n250_p100_balanced", "n250_p500", "n250_p500_balanced", "n250_p1000")#, "n472_p5000")
for (y_dgp in y_dgps) {
  cat(sprintf("\n\n## %s {.tabset .tabset-pills .tabset-square}\n\n", y_dgp))
  for (sim_setup in sim_setups) {
    cat(sprintf("\n\n### %s {.tabset .tabset-pills .tabset-circle}\n\n", sim_setup))
    sim_name <- sprintf("%s.correlation_sims_%s.normal_block_cor_%s_dgp", fpath, sim_setup, y_dgp)
    fname <- file.path(
      results_dir, 
      sim_name,
      "varying_heritability_rho",
      sprintf("seed%s", seed),
      "results.csv"
    )
    if (!file.exists(fname)) {
      next
    }
    results <- data.table::fread(fname)
    
    n <- as.numeric(stringr::str_extract(sim_setup, "(?<=n)[0-9]+"))
    p <- as.numeric(stringr::str_extract(sim_setup, "(?<=p)[0-9]+"))
    balanced <- stringr::str_detect(sim_setup, "balanced")
    if (y_dgp == "linear") {
      nsig <- 4
    } else {
      nsig <- 5
    }
    
    sig_ids <- 0:nsig
    if (balanced) {
      cnsig_ids <- nsig:(p / 2 - 1)
    } else if (p == 20) {
      cnsig_ids <- nsig:9
    } else {
      cnsig_ids <- nsig:24
    }
    # print(sprintf("%s: %s, %s", sim_setup, nsig, max(cnsig_ids)))
    
    plt <- plot_perturbation_stability(
      # results %>% dplyr::filter(rho_name == RHO),
      results,
      facet_rows = "heritability_name",
      facet_cols = "rho_name",
      param_name = NULL,
      sig_ids = sig_ids,
      cnsig_ids = cnsig_ids,
      plot_types = "errbar",
      manual_color_palette = manual_color_palette,
      show_methods = show_methods,
      method_labels = method_labels
    )
    # print(plt$agg)
    # readline(prompt = "Press [enter]")
    vthemes::subchunkify(
      plt$agg, i = sim_name, fig_height = fig_height, fig_width = fig_width
    )
  }
}

y_dgps <- c("logistic")
# for (y_dgp in y_dgps) {
#   cat(sprintf("\n\n## %s {.tabset .tabset-pills .tabset-square}\n\n", y_dgp))
#   for (sim_setup in sim_setups) {
#     cat(sprintf("\n\n### %s {.tabset .tabset-pills .tabset-circle}\n\n", sim_setup))
#     sim_name <- sprintf("%s.correlation_sims_%s.normal_block_cor_%s_dgp", fpath, sim_setup, y_dgp)
#     fname <- file.path(
#       results_dir,
#       sim_name,
#       "varying_beta_rho",
#       sprintf("seed%s", seed),
#       "results.csv"
#     )
#     results <- data.table::fread(fname)
# 
#     if (!file.exists(fname)) {
#       next
#     }
#     results <- data.table::fread(fname)
#     
#     n <- as.numeric(stringr::str_extract(sim_setup, "(?<=n)[0-9]+"))
#     p <- as.numeric(stringr::str_extract(sim_setup, "(?<=p)[0-9]+"))
#     balanced <- stringr::str_detect(sim_setup, "balanced")
#     nsig <- 4
#     
#     sig_ids <- 0:nsig
#     if (balanced) {
#       cnsig_ids <- nsig:(p / 2 - 1)
#     } else if (p == 20) {
#       cnsig_ids <- nsig:9
#     } else {
#       cnsig_ids <- nsig:24
#     }
# 
#     plt <- plot_perturbation_stability(
#       # results %>% dplyr::filter(rho_name == RHO),
#       results,
#       facet_rows = "beta_name",
#       facet_cols = "rho_name",
#       param_name = NULL,
#       facet_row_names = "Avg Rank (Beta = %s)",
#       sig_ids = sig_ids,
#       cnsig_ids = cnsig_ids,
#       descending_methods = unique(results$fi)[stringr::str_detect(unique(results$fi), "logloss")],
#       manual_color_palette = manual_color_palette,
#       show_methods = show_methods,
#       method_labels = method_labels
#     )
#     vthemes::subchunkify(
#       plt$agg, i = sim_name, fig_height = fig_height, fig_width = fig_width
#     )
#   }
# }

```

# Entropy Bias Simulations: Figure xx {.tabset .tabset-vmodern}

```{r entropy-bias, eval = FALSE, results = "asis"}
manual_color_palette <- rev(c("black", "orange", "#71beb7", "#218a1e", "#cc3399"))
show_methods <- rev(c("GMDI_ridge", "MDA", "MDI", "MDI-oob", "TreeSHAP"))
method_labels <- rev(c("GMDI", "MDA", "MDI", "MDI-oob", "TreeSHAP"))
alpha_values <- rev(c(1, rep(1, length(method_labels) - 1)))
y_limits <- c(1, 4.5)

metric <- "rocauc"
metric_name <- "AUROC"
sim_name <- "gmdi.mdi_bias_sims.entropy_sims.linear_dgp"
fname <- file.path(
  results_dir, 
  sim_name,
  "varying_heritability_n",
  sprintf("seed%s", seed),
  "results.csv"
)
results <- data.table::fread(fname) %>%
  dplyr::filter(heritability_name == 0.1)

custom_group_fun <- function(var) {
  return(var)
}

plt_base <- plot_perturbation_stability(
  results,
  facet_rows = "heritability_name",
  facet_cols = "n_name", 
  group_fun = custom_group_fun, 
  param_name = NULL,
  plot_types = "errbar",
  manual_color_palette = manual_color_palette,
  show_methods = show_methods,
  method_labels = method_labels
)

plt_df <- plt_base$agg[[1]]$data
nreps <- length(unique(results$rep))

plt_regression <- plt_df %>%
  dplyr::filter(group == 0) %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = n_name, y = .mean, color = fi, alpha = fi) +
  ggplot2::geom_line(size = line_size) +
  # ggplot2::geom_ribbon(
  #   ggplot2::aes(
  #     x = n_name,
  #     ymin = .mean - (.sd / sqrt(nreps)),
  #     ymax = .mean + (.sd / sqrt(nreps)),
  #     fill = fi
  #   ),
  #   inherit.aes = FALSE, alpha = 0.2
  # ) +
  ggplot2::labs(
    x = "Sample Size", 
    y = expression("Average Rank of "*x[1]), 
    color = "Method",
    title = "Regression"
  ) +
  ggplot2::guides(fill = "none", alpha = "none") +
  ggplot2::scale_color_manual(values = manual_color_palette,
                              labels = method_labels,
                              guide = ggplot2::guide_legend(reverse = TRUE)) +
  ggplot2::scale_alpha_manual(values = alpha_values, 
                              labels = method_labels) +
  ggplot2::coord_cartesian(
    ylim = y_limits
  ) +
  vthemes::theme_vmodern(
    size_preset = "medium", bg_color = "white", grid_color = "white",
    axis.ticks = ggplot2::element_line(size = ggplot2::rel(2), colour = "black"),
    axis.text = ggplot2::element_text(size = 14),
    axis.title = ggplot2::element_text(size = 18, face = "plain"),
    legend.text = ggplot2::element_text(size = 14),
    legend.title = ggplot2::element_text(size = 18),
    plot.title = ggplot2::element_text(size = 20, face = "bold", hjust = 0.5)
  )

# manual_color_palette <- rev(c("black", "#7D2DFF", "orange", "#71beb7", "#218a1e", "#7B5D44", "#cc3399"))
# show_methods <- rev(c("GMDI_ridge", "GMDI_logistic_logloss", "Permutation", "MDI", "MDI-oob", "MDA", "TreeSHAP"))
# method_labels <- rev(c("GMDI (ridge)", "GMDI (logistic)", "Permutation", "MDI", "MDI-oob", "MDA", "TreeSHAP"))
# alpha_values <- rev(c(1, 1, rep(0.7, length(method_labels) - 2)))

metric <- "rocauc"
metric_name <- "AUROC"
sim_name <- "gmdi.mdi_bias_sims.entropy_sims.logistic_dgp"
fname <- file.path(
  results_dir, 
  sim_name,
  "varying_c_n",
  sprintf("seed%s", seed),
  "results.csv"
)
results <- data.table::fread(fname)

custom_group_fun <- function(var) {
  return(var)
}

plt_base <- plot_perturbation_stability(
  results,
  facet_rows = "c_name",
  facet_cols = "n_name", 
  group_fun = custom_group_fun, 
  descending_methods = "GMDI (logistic)",
  param_name = NULL,
  plot_types = "errbar",
  manual_color_palette = manual_color_palette,
  show_methods = show_methods,
  method_labels = method_labels
)

plt_df <- plt_base$agg[[1]]$data
nreps <- length(unique(results$rep))

plt_classification <- plt_df %>%
  dplyr::filter(group == 0) %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = n_name, y = .mean, color = fi, alpha = fi) +
  ggplot2::geom_line(size = line_size) +
  # ggplot2::geom_ribbon(
  #   ggplot2::aes(
  #     x = n_name,
  #     ymin = .mean - (.sd / sqrt(nreps)),
  #     ymax = .mean + (.sd / sqrt(nreps)),
  #     fill = fi
  #   ),
  #   inherit.aes = FALSE, alpha = 0.2
  # ) +
  ggplot2::labs(
    x = "Sample Size", 
    y = expression("Average Rank of "*x[1]), 
    color = "Method",
    title = "Classification"
  ) +
  ggplot2::guides(fill = "none", alpha = "none") +
  ggplot2::scale_color_manual(values = manual_color_palette,
                              labels = method_labels,
                              guide = ggplot2::guide_legend(reverse = TRUE)) +
  ggplot2::scale_alpha_manual(values = alpha_values, 
                              labels = method_labels) +
  ggplot2::coord_cartesian(
    ylim = y_limits
  ) +
  vthemes::theme_vmodern(
    size_preset = "medium", bg_color = "white", grid_color = "white",
    axis.ticks = ggplot2::element_line(size = ggplot2::rel(2), colour = "black"),
    axis.text = ggplot2::element_text(size = 14),
    axis.title = ggplot2::element_text(size = 18, face = "plain"),
    legend.text = ggplot2::element_text(size = 14),
    legend.title = ggplot2::element_text(size = 18),
    plot.title = ggplot2::element_text(size = 20, face = "bold", hjust = 0.5)
  )

plt <- plt_regression + plt_classification + patchwork::plot_layout(guides = "collect")
ggplot2::ggsave(plt, filename = file.path(plots_dir, "entropy_sims.pdf"), 
                width = fig_width * 1, height = fig_height * .65)
```

```{r entropy-bias2, eval = FALSE, results = "asis"}

fpath <- "gmdi.mdi_bias_sims"
y_dgps <- c("linear", "lss", "partial_linear_lss")
support_idxs <- 0:5
true_support <- list(
  linear = data.frame(
    var = support_idxs, 
    group =  c("Rare1", "Rare2", "Rare3", "Common1", "Common2", "Common3")
  ),
  lss = data.frame(
    var = support_idxs, 
    group =  c("Rare1", "Rare2", "Common1", "Common2", "Common-Rare", "Rare-Common")
  ),
  partial_linear_lss = data.frame(
    var = support_idxs, 
    group =  c("Rare1", "Rare2", "Common1", "Common2", "Common-Rare", "Rare-Common")
  )
)
# group_fun <- function(var, true_support_df) {
#   dplyr::left_join(
#     x = data.frame(var = var),
#     y = true_support_df,
#     by = "var"
#   ) %>%
#     dplyr::mutate(
#       group = ifelse(is.na(group), "Non-signal", group)
#     ) %>%
#     dplyr::pull(group)
# }
group_fun <- function(var, true_support_df) {
  dplyr::left_join(
    x = data.frame(var = var),
    y = true_support_df,
    by = "var"
  ) %>%
    dplyr::pull(group)
}
for (y_dgp in y_dgps) {
  cat(sprintf("\n\n## %s {.tabset .tabset-pills .tabset-square}\n\n", y_dgp))
  sim_name <- sprintf("%s.entropy_sims.1000g_%s_dgp", fpath, y_dgp)
  fname <- file.path(
    results_dir, 
    sim_name,
    "varying_heritability_sample_row_n",
    sprintf("seed%s", seed),
    "results.csv"
  )
  results <- data.table::fread(fname)
  
  plt <- plot_perturbation_stability(
    results %>% dplyr::filter(var %in% support_idxs),
    facet_rows = "heritability_name",
    facet_cols = "sample_row_n",
    param_name = NULL,
    group_fun = group_fun,
    true_support_df = true_support[[y_dgp]],
    # plot_types = c("boxplot"),
    manual_color_palette = manual_color_palette, 
    show_methods = show_methods,
    method_labels = method_labels
  )
  vthemes::subchunkify(
    plt$agg & vthemes::theme_vmodern(x_text_angle = TRUE), 
    i = sim_name, fig_height = fig_height * 2.5, fig_width = fig_width
  )
}

```

# CCLE Case Study: Figure xx {.tabset .tabset-pills .tabset-square}

```{r ccle, eval = FALSE, results = "asis"}
# show_methods <- c("GMDI_ridge", "Permutation", "MDI", "MDI-oob", "TreeSHAP")
manual_color_palette <- c("black", "orange", "#71beb7", "#218a1e", "#cc3399")
show_methods <- c("GMDI", "MDA", "MDI", "MDI-oob", "TreeSHAP")
method_labels <- c("GMDI", "MDA", "MDI", "MDI-oob", "TreeSHAP")

fpath <- "gmdi.real_data_case_study.ccle_rnaseq_regression-"
fname <- file.path(
  results_dir, 
  fpath,
  sprintf("seed%s", seed),
  "results.csv"
)
X <- data.table::fread("/global/scratch/users/tiffanytang/feature_importance/data/X_ccle_rnaseq_log_transformed_filtered5000.csv")
X_columns <- colnames(X)
results <- data.table::fread(fname)

out <- plot_top_stability(
  results,
  group_id = "y_task",
  top_r = 10,
  show_max_features = 5,
  varnames = colnames(X),
  base_method = "GMDI",
  return_df = TRUE,
  descending_methods = NULL,
  manual_color_palette = rev(manual_color_palette),
  show_methods = rev(show_methods),
  method_labels = rev(method_labels)
)

ranking_df <- out$rankings
stability_df <- out$stability
plt_ls <- out$plot_ls

# get gene names instead of ENSG ids
library(biomaRt)
ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")
varnames <- getBM(
  attributes = c("ensembl_gene_id", "hgnc_symbol"), 
  filters = "ensembl_gene_id", 
  values = stringr::str_remove(colnames(X), "\\.[^\\.]+$"), 
  mart = ensembl
) %>%
  dplyr::filter(hgnc_symbol != "") %>%
  dplyr::bind_rows(
    data.frame(ensembl_gene_id = stringr::str_remove(colnames(X), "\\.[^\\.]+$"),
               hgnc_symbol = stringr::str_remove(colnames(X), "\\.[^\\.]+$"))
  ) %>%
  dplyr::distinct(ensembl_gene_id, .keep_all = TRUE)
  # dplyr::bind_rows(
  #   # add gene names from other databases for those mixxing in ensembl
  #   data.table::fread("../../data/ensg_to_gene_supplement.csv")
  # )

# get top 10 genes
top_genes <- ranking_df %>%
  dplyr::group_by(y_task, fi, var) %>%
  dplyr::summarise(mean_rank = mean(rank)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(y_task, mean_rank) %>%
  dplyr::group_by(y_task, fi) %>%
  dplyr::mutate(rank = 1:dplyr::n()) %>%
  dplyr::ungroup()

top_genes_table <- top_genes %>%
  dplyr::filter(rank <= 5) %>%
  dplyr::left_join(
    y = data.frame(var = 0:(ncol(X) - 1), 
                   ensembl_gene_id = stringr::str_remove(colnames(X), "\\.[^\\.]+$")),
    by = "var"
  ) %>%
  dplyr::left_join(
    y = varnames, by = "ensembl_gene_id"
  ) %>%
  dplyr::mutate(
    value = sprintf("%s (%s)", hgnc_symbol, round(mean_rank, 2))
  ) %>%
  tidyr::pivot_wider(
    id_cols = c(y_task, rank), 
    names_from = fi, 
    values_from = value
  ) %>%
  dplyr::rename(
    "Drug" = "y_task",
    "Rank" = "rank"
  )

# write.csv(
#   top_genes_table, file.path(tables_dir, "ccle_rnaseq_top_genes_table.csv"),
#   row.names = FALSE, quote = FALSE
# )

# get # genes with perfect stability
stable_genes_kable <- stability_df %>%
  dplyr::group_by(fi, y_task) %>%
  dplyr::summarise(stability_1 = sum(stability_score == 1)) %>%
  tidyr::pivot_wider(id_cols = fi, names_from = y_task, values_from = stability_1) %>%
  dplyr::ungroup() %>%
  as.data.frame()

for (plt_id in names(plt_ls)) {
  cat(sprintf("\n\n## %s \n\n", plt_id))
  plt <- plt_ls[[plt_id]]
  if (plt_id == "Summary") {
    plt <- plt + ggplot2::labs(y = "Drug")
    vthemes::subchunkify(
      plt, i = sprintf("%s-%s", fpath, plt_id), 
      fig_height = fig_height, fig_width = fig_width
    )
    ggplot2::ggsave(plt, filename = file.path(plots_dir, "ccle_rnaseq_stability_top10.pdf"), 
                    width = fig_width * 1.5, height = fig_height * 1.1)
    
    cat("\n\n## Table of Top Genes \n\n")
    top_genes_kable <- top_genes_table %>%
      dplyr::filter(Rank <= 5) %>%
      dplyr::select(-Drug) %>%
      dplyr::rename(" " = "Rank") %>%
      # vthemes::pretty_kable(]) %>%
      vthemes::pretty_kable(format = "latex", longtable = TRUE) %>%
      kableExtra::kable_styling(latex_options = "repeat_header") %>%
      # kableExtra::collapse_rows(columns = 1, valign = "middle")
      kableExtra::pack_rows(
        index = rep(5, 24) %>% setNames(unique(top_genes_table$Drug))
      )
    vthemes::subchunkify(
      top_genes_kable, i = sprintf("%s-table", fpath)
    )
  } else {
    vthemes::subchunkify(
      plotly::ggplotly(plt), i = sprintf("%s-%s", fpath, plt_id), 
      fig_height = fig_height, fig_width = fig_width
    )
  }
}
```

```{r ccle-no-oob, eval = FALSE, results = "asis"}
manual_color_palette_nooob <- manual_color_palette[show_methods != "MDI-oob"]
show_methods_nooob <- show_methods[show_methods != "MDI-oob"]
method_labels_nooob <- method_labels[show_methods != "MDI-oob"]

# v2
manual_color_palette_nooob <- manual_color_palette[!(show_methods %in% c("MDI-oob", "MDA"))]
show_methods_nooob <- show_methods[!(show_methods %in% c("MDI-oob", "MDA"))]
method_labels_nooob <- method_labels[!(show_methods %in% c("MDI-oob", "MDA"))]

# v3
manual_color_palette_nooob <- manual_color_palette
show_methods_nooob <- show_methods
method_labels_nooob <- method_labels

fpath <- "gmdi.real_data_case_study.ccle_rnaseq_regression-"
fname <- file.path(
  results_dir, 
  fpath,
  sprintf("seed%s", seed),
  "results.csv"
)
X <- data.table::fread("/global/scratch/users/tiffanytang/feature_importance/data/X_ccle_rnaseq_log_transformed_filtered5000.csv")
results <- data.table::fread(fname)
plt_ls <- plot_top_stability(
  results,
  group_id = "y_task",
  top_r = 10,
  show_max_features = 5,
  varnames = colnames(X),
  base_method = "GMDI",
  return_df = FALSE,
  descending_methods = NULL,
  manual_color_palette = manual_color_palette_nooob,
  show_methods = show_methods_nooob,
  method_labels = method_labels_nooob
)

keep_drugs <- c("Panobinostat", "Lapatinib", "TAE684", "L-685458")
breaks_ls <- list(
  Panobinostat = c(10, 170),
  `L-685458` = c(250, 450)
)
small_plt_ls <- list()
for (drug in keep_drugs) {
  plt <- plt_ls[[drug]]
  # if (!is.null(breaks_ls[[drug]])) {
  #   plt <- plt +
  #     ggbreak::scale_y_break(breaks_ls[[drug]])
  # }
  if (drug != keep_drugs[1]) {
    plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
  }
  small_plt_ls[[drug]] <- plt
}
small_plt_ls[[1]] + small_plt_ls[[2]] + small_plt_ls[[3]] + small_plt_ls[[4]] +
  patchwork::plot_layout(nrow = 1, ncol = 4, guides = "collect")
plt <- patchwork::wrap_plots(small_plt_ls, nrow = 1, ncol = 4, guides = "collect") &
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5),
    panel.background = ggplot2::element_rect(fill = "white"),
    panel.grid.major = ggplot2::element_line(color = "grey95", size = ggplot2::rel(0.25))
  )
ggplot2::ggsave(plt, filename = file.path(plots_dir, "ccle_rnaseq_stability_select_features.pdf"),
                width = fig_width * 1, height = fig_height * 0.5)
ggplot2::ggsave(plt, filename = file.path(plots_dir, "ccle_rnaseq_stability_select_features_v2.pdf"),
                width = fig_width * 1, height = fig_height * 0.5)
ggplot2::ggsave(plt, filename = file.path(plots_dir, "ccle_rnaseq_stability_select_features_v3.pdf"),
                width = fig_width * 1, height = fig_height * 0.5)

all_plt_ls <- list()
for (idx in 1:length(unique(results$y_task))) {
  drug <- sort(unique(results$y_task))[idx]
  plt <- plt_ls[[drug]]
  if ((idx - 1) %% 4 != 0) {
    plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
  }
  if ((idx - 1) %/% 4 != 5) {
    plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
  }
  all_plt_ls[[drug]] <- plt
}
plt <- patchwork::wrap_plots(all_plt_ls, guides = "collect", ncol = 4, nrow = 6) &
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5),
    panel.background = ggplot2::element_rect(fill = "white"),
    panel.grid.major = ggplot2::element_line(color = "grey95", size = ggplot2::rel(0.25))
  )
ggplot2::ggsave(plt, filename = file.path(plots_dir, "ccle_rnaseq_stability_select_features_all.pdf"),
                width = fig_width * 1, height = fig_height * 2)
ggplot2::ggsave(plt, filename = file.path(plots_dir, "ccle_rnaseq_stability_select_features_all_v2.pdf"),
                width = fig_width * 1, height = fig_height * 2)
ggplot2::ggsave(plt, filename = file.path(plots_dir, "ccle_rnaseq_stability_select_features_all_v3.pdf"),
                width = fig_width * 1, height = fig_height * 2)

```

# TCGA BRCA Case Study: Figure xx {.tabset .tabset-pills .tabset-square}

```{r tcga, eval = FALSE, results = "asis"}
fpath <- "gmdi.real_data_case_study.tcga_brca_classification-"
fname <- file.path(
  results_dir, 
  fpath,
  sprintf("seed%s", seed),
  "results.csv"
)
X <- data.table::fread("/global/scratch/users/tiffanytang/feature_importance/data/X_tcga_var_filtered_log_transformed.csv")
results <- data.table::fread(fname)
plt_ls <- plot_top_stability(
  results,
  group_id = NULL,
  top_r = 10,
  show_max_features = 5,
  varnames = colnames(X),
  base_method = "GMDI_ridge", 
  return_df = FALSE,
  descending_methods = unique(results$fi)[(stringr::str_detect(unique(results$fi), "logloss") &
                                             stringr::str_detect(unique(results$fi), "GMDI")) |
                                            (!stringr::str_detect(unique(results$fi), "logloss") &
                                             stringr::str_detect(unique(results$fi), "GPermutation"))],
  manual_color_palette = manual_color_palette_all,
  show_methods = show_methods_all,
  method_labels = method_labels_all
)

cat("\n\n## Non-zero Stability Scores Per Method\n\n")
vthemes::subchunkify(
  plt_ls[[1]], i = sprintf("%s-%s", fpath, 1), 
  fig_height = fig_height * round(length(unique(results$fi)) / 2), fig_width = fig_width
)

cat("\n\n## Stability of Top Features\n\n")
vthemes::subchunkify(
  plotly::ggplotly(plt_ls[[2]]), i = sprintf("%s-%s", fpath, 2), 
  fig_height = fig_height, fig_width = fig_width
)
```

# TCGA BRCA Case Study (min_samples_per_leaf = 5): Figure xx {.tabset .tabset-pills .tabset-square}

```{r tcga-mspl5, eval = FALSE, results = "asis"}
fpath <- "gmdi.real_data_case_study.tcga_brca_classification_mspl5-"
fname <- file.path(
  results_dir, 
  fpath,
  sprintf("seed%s", seed),
  "results.csv"
)
X <- data.table::fread("/global/scratch/users/tiffanytang/feature_importance/data/X_tcga_var_filtered_log_transformed.csv")
results <- data.table::fread(fname)
plt_ls <- plot_top_stability(
  results,
  group_id = NULL,
  top_r = 10,
  show_max_features = 5,
  varnames = colnames(X),
  base_method = "GMDI_ridge", 
  return_df = FALSE,
  descending_methods = unique(results$fi)[(stringr::str_detect(unique(results$fi), "logloss") &
                                             stringr::str_detect(unique(results$fi), "GMDI")) |
                                            (!stringr::str_detect(unique(results$fi), "logloss") &
                                             stringr::str_detect(unique(results$fi), "GPermutation"))],
  manual_color_palette = manual_color_palette_all,
  show_methods = show_methods_all,
  method_labels = method_labels_all
)

cat("\n\n## Non-zero Stability Scores Per Method\n\n")
vthemes::subchunkify(
  plt_ls[[1]], i = sprintf("%s-%s", fpath, 1), 
  fig_height = fig_height * round(length(unique(results$fi)) / 2), fig_width = fig_width
)

cat("\n\n## Stability of Top Features\n\n")
vthemes::subchunkify(
  plotly::ggplotly(plt_ls[[2]]), i = sprintf("%s-%s", fpath, 2), 
  fig_height = fig_height, fig_width = fig_width
)
```

# MDI Bias: Figure 6

```{r eval = FALSE}
fname <- file.path("results_entropy.csv")
results <- data.table::fread(fname) %>%
  reformat_results()

plt_ls <- list()
for (metric in metrics_all) {
  metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                  metric == "prauc" ~ "AUPRC")
  plt <- results %>%
    plot_metrics(
      metric = metric,
      x_str = "n", 
      facet_str = NULL, 
      point_size = point_size, 
      line_size = line_size, 
      errbar_width = errbar_width, 
      manual_color_palette = manual_color_palette, 
      show_methods = show_methods, 
      method_labels = method_labels, 
      custom_theme = custom_theme, 
      inside_legend = FALSE
    ) +
    ggplot2::labs(
      x = "Sample Size", y = metric_name,
      color = "Method", alpha = "Method"
    )
  plt_ls[[metric]] <- plt
}

plt <- purrr::reduce(plt_ls, `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14),
    legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 1, guides = "collect")
ggplot2::ggsave(
  file.path(plots_dir, "appendix", "entropy_sims.pdf"),
  plot = plt, units = "in", width = 8.5, height = 3
)


```

# $r^2f$ Modeling Choices: Figure 8

```{r eval = FALSE}
vary_param_name <- "heritability_sample_row_n"
cur_manual_color_palette <- c("black", "#ff9902", "#6caa52", "#4a86e8", "#a64d79")
cur_show_methods <- c("r2f", 
                      "r2f (Without Refit)", 
                      "r2f (Without Xk)", 
                      "r2f (AIC)", 
                      "r2f (CV)")
cur_method_labels <- c(bquote(~r^2*"f"), 
                       bquote(~r^2*"f (No Refit)"), 
                       bquote(~r^2*"f (No"~X[k]*")"), 
                       bquote(~r^2*"f (AIC)"), 
                       bquote(~r^2*"f (CV)"))
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")
metric <- "rocauc"

results_ls <- list()
for (y_model in y_models) {
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.r2f_algorithmic_choices.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

for (x_model in x_models) {
  plt_ls <- list()
  for (y_model in y_models) {
    plt_ls[[y_model]] <- list()
    for (h in heritabilities) {
      metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                      metric == "prauc" ~ "AUPRC")
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = cur_manual_color_palette, 
          show_methods = cur_show_methods, 
          method_labels = cur_method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        ) +
        ggplot2::theme(
          legend.position = c(0.75, 0.4),
          legend.background = ggplot2::element_rect(
            color = "slategray", size = .1
          )
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (y_model != y_models[length(y_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) |
          (y_model != y_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[y_model]][[as.character(h)]] <- plt
    }
    
    plt <- purrr::reduce(plt_ls[[y_model]], `+`) *
      ggplot2::theme(
        axis.text = ggplot2::element_text(size = 11),
        axis.title = ggplot2::element_text(size = 16, face = "plain"),
        legend.text = ggplot2::element_text(size = 14)
        # legend.title = ggplot2::element_text(face = "plain", size = 16)
      ) +
      plot_layout(nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix", 
                sprintf("model_choices_%s_%s_%s.pdf", y_model, x_model, metric)),
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# AUROC Appendix: Figures 9-12

```{r eval = FALSE}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int", "linear_lss")
x_models <- c("german", "ukbb", "ccle_prot", "fmri")
metric <- "rocauc"

results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(
        metric == "rocauc" ~ "AUROC",
        metric == "prauc" ~ "PRAUC"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sims_appendix_%s_%s_%s_errbars.pdf", 
                        y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# AUPRC Appendix: Figures 13-16

```{r eval = FALSE}
vary_param_name <- "heritability_sample_row_n"
y_models <- c("linear", "lss", "poly_int", "linear_lss")
x_models <- c("german", "ukbb", "ccle_prot", "fmri")
metric <- "prauc"

results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(
        metric == "rocauc" ~ "AUROC",
        metric == "prauc" ~ "PRAUC"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sims_appendix_%s_%s_%s_errbars.pdf", 
                        y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# TPR Appendix: Figure 17

```{r eval = FALSE}
y_models <- "linear"
x_models <- c("german", "ukbb")

results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

facet_vars <- c("PVE" = "heritability", "n" = "sample_row_n")
for (x_model in x_models) {
  for (y_model in y_models) {
    results <- results_ls[[y_model]][[x_model]]
    plt <- results %>%
      plot_tpr(facet_vars = facet_vars, 
               manual_color_palette = manual_color_palette, 
               show_methods = show_methods,
               method_labels = method_labels, 
               custom_theme = vthemes::theme_vmodern(size_preset = "medium")) +
      ggplot2::coord_cartesian(xlim = c(1, 10)) +
      ggplot2::scale_x_continuous(breaks = c(2, 4, 6, 8, 10)) +
      ggplot2::theme(panel.background = ggplot2::element_rect(fill = "white"), 
                     panel.grid.major = ggplot2::element_line(size = .1))
    ncols <- length(unique(results$sample_row_n))
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sims_appendix_%s_%s_tpr.pdf", 
                        y_model, x_model)), 
      plot = plt, units = "in", width = 12, height = 1.5 * ncols
    )
  }
}
```

# Misspecified Model Appendix: Figures 18-19

```{r eval = FALSE}
vary_param_name <- "heritability_sample_row_n"
# y_models <- c("linear", "lss", "poly_int")
# x_models <- c("german", "ukbb")
y_models <- "partial_linear_lss2"
x_models <- "enhancer"

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name, "_omitted_vars"), 
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

for (metric in metrics_all) {
  plt_ls <- list()
  for (h in heritabilities) {
    plt_ls[[as.character(h)]] <- list()
    for (x_model in x_models) {
      plt_ls[[as.character(h)]][[x_model]] <- list()
      for (y_model in y_models) {
        sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
        sim_title <- dplyr::case_when(
          x_model == "ccle_prot" ~ "CCLE Protein",
          x_model == "ukbb" ~ "UK Biobank",
          x_model == "german" ~ "German Credit",
          x_model == "fmri" ~ "fMRI"
        )
        metric_name <- dplyr::case_when(
          metric == "rocauc" ~ "AUROC",
          metric == "prauc" ~ "PRAUC"
        )
        plt <- results_ls[[y_model]][[x_model]] %>%
          dplyr::filter(heritability == !!h) %>%
          plot_metrics(
            metric = metric,
            x_str = "sample_row_n", 
            facet_str = NULL, 
            point_size = point_size, 
            line_size = line_size, 
            errbar_width = errbar_width, 
            manual_color_palette = manual_color_palette, 
            show_methods = show_methods, 
            method_labels = method_labels, 
            custom_theme = custom_theme, 
            inside_legend = TRUE
          ) +
          ggplot2::labs(
            x = "Sample Size", y = metric_name,
            color = "Method", alpha = "Method",
            title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
          )
        if (h != heritabilities[1]) {
          plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
        }
        if (x_model != x_models[length(x_models)]) {
          plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
        }
        if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
          plt <- plt + ggplot2::guides(color = "none", alpha = "none")
        }
        plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
      }
    }
  }
  
  for (y_model in y_models) {
    for (x_model in x_models) {
      plt <- list()
      for (h in heritabilities) {
        cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
        if (identical(plt, list())) {
          plt <- cur_plt
        } else {
          plt <- plt + cur_plt
        }
      }
      plt <- plt +
        plot_layout(ncol = 2, nrow = 2)
      ggplot2::ggsave(
        file.path(plots_dir, "appendix",
                  sprintf("real_data_artificial_y_omitted_vars_sims_%s_%s_%s_errbars.pdf", 
                          y_model, x_model, metric)), 
        plot = plt, units = "in", width = 10, height = 8
      )
    }
  }
}

```

# Varying Sparsity Appendix: Figure 20

```{r eval = FALSE}
vary_param_names <- c("linear" = "heritability_s", 
                      "lss" = "heritability_m",
                      "poly_int" = "heritability_m")
y_models <- c("linear", "lss", "poly_int")
x_models <- c("german", "ukbb")
metric <- "rocauc"

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.sparsity_sims.", sim_name), 
                       paste0("varying_", vary_param_names[y_model]), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (h in heritabilities) {
  plt_ls[[as.character(h)]] <- list()
  for (x_model in x_models) {
    plt_ls[[as.character(h)]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                      metric == "prauc" ~ "AUPRC")
      x_str <- ifelse(y_model == "linear", "s", "m")
      plt <- results_ls[[y_model]][[x_model]] %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = x_str, 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = toupper(x_str), y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (h != heritabilities[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (x_model != x_models[length(x_models)]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((h != heritabilities[length(heritabilities)]) | (x_model != x_models[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[as.character(h)]][[x_model]][[y_model]] <- plt
    }
  }
}

for (y_model in y_models) {
  for (x_model in x_models) {
    plt <- list()
    for (h in heritabilities) {
      cur_plt <- plt_ls[[as.character(h)]][[x_model]][[y_model]]
      if (identical(plt, list())) {
        plt <- cur_plt
      } else {
        plt <- plt + cur_plt
      }
    }
    plt <- plt +
      plot_layout(ncol = length(heritabilities), nrow = 1)
    ggplot2::ggsave(
      file.path(plots_dir, "appendix",
                sprintf("real_data_artificial_y_sparsity_sims_%s_%s_%s_errbars.pdf", 
                        y_model, x_model, metric)), 
      plot = plt, units = "in", width = 14, height = 3
    )
  }
}

```

# Logistic Regression Appendix: Figure 21

```{r eval = FALSE}
vary_param_name <- "sample_row_n"
y_models <- "logistic"
x_models <- c("german", "ukbb", "ccle_prot", "fmri")

# read in data
results_ls <- list()
for (y_model in y_models) {
  results_ls[[y_model]] <- list()
  for (x_model in x_models) {
    sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
    fname <- file.path(results_dir, paste0("r2f.", sim_name),
                       paste0("varying_", vary_param_name), 
                       paste0("seed", seed), "results.csv")
    results_ls[[y_model]][[x_model]] <- data.table::fread(fname) %>%
      reformat_results()
  }
}

plt_ls <- list()
for (metric in metrics_all) {
  metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                  metric == "prauc" ~ "AUPRC")
  for (x_model in x_models) {
    plt_ls[[metric]][[x_model]] <- list()
    for (y_model in y_models) {
      sim_name <- sprintf("%s_%s_dgp", x_model, y_model)
      sim_title <- dplyr::case_when(
        x_model == "ccle_prot" ~ "CCLE Protein",
        x_model == "ukbb" ~ "UK Biobank",
        x_model == "german" ~ "German Credit",
        x_model == "fmri" ~ "fMRI"
      )
      plt <- results_ls[[y_model]][[x_model]] %>%
        plot_metrics(
          metric = metric,
          x_str = "sample_row_n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme, 
          inside_legend = TRUE
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
      if (x_model != x_models[1]) {
        plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
      }
      if (metric == metrics_all[1]) {
        plt <- plt + ggplot2::theme(axis.title.x = ggplot2::element_blank())
      }
      if ((x_model != x_models[length(x_models)]) | (metric != metrics_all[1])) {
        plt <- plt + ggplot2::guides(color = "none", alpha = "none")
      }
      plt_ls[[metric]][[x_model]] <- plt
    }
  }
}

plt <- purrr::reduce(c(plt_ls$rocauc, plt_ls$prauc), `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14)
    # legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 2)
ggplot2::ggsave(
  file.path(plots_dir, "appendix", "logistic_dgp.pdf"),
  plot = plt, units = "in", width = 14, height = 6
)

```

# CART Simulation Appendix: Figure 22

```{r eval = FALSE}
fname <- file.path(results_dir, "r2f.ccle_prot_cart_dgp", 
                   "varying_heritability_n",
                   paste0("seed", seed), "results.csv")
results <- data.table::fread(fname) %>%
  reformat_results()

plt_ls <- list()
for (metric in metrics_all) {
  metric_name <- dplyr::case_when(metric == "rocauc" ~ "AUROC",
                                  metric == "prauc" ~ "AUPRC")
  plt_ls[[metric]] <- list()
  for (h in heritabilities) {
    plt <- results %>%
        dplyr::filter(heritability == !!h) %>%
        plot_metrics(
          metric = metric,
          x_str = "n", 
          facet_str = NULL, 
          point_size = point_size, 
          line_size = line_size, 
          errbar_width = errbar_width, 
          manual_color_palette = manual_color_palette, 
          show_methods = show_methods, 
          method_labels = method_labels, 
          custom_theme = custom_theme
        ) +
        ggplot2::labs(
          x = "Sample Size", y = metric_name,
          color = "Method", alpha = "Method",
          title = sprintf("%s (p = %s)", sim_title, p_models[[x_model]])
        )
    if (h != heritabilities[1]) {
      plt <- plt + ggplot2::theme(axis.title.y = ggplot2::element_blank())
    }
    plt_ls[[metric]][[as.character(h)]] <- plt
  }
}

plt <- purrr::reduce(c(plt_ls$rocauc, plt_ls$prauc), `+`) *
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 11),
    axis.title = ggplot2::element_text(size = 16, face = "plain"),
    legend.text = ggplot2::element_text(size = 14),
    legend.title = ggplot2::element_text(face = "plain", size = 16)
  ) +
  plot_layout(nrow = 2, guides = "collect")
ggplot2::ggsave(
  file.path(plots_dir, "appendix", "ccle_prot_cart_dgp.pdf"),
  plot = plt, units = "in", width = 14, height = 6
)

```


